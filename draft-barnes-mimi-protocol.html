<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>More Instant Messaging Interoperability: The Protocol</title>
<meta content="Richard L. Barnes" name="author">
<meta content="Matthew Hodgson" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="Rohan Mahy" name="author">
<meta content="Travis Ralston" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider. 
    " name="description">
<meta content="xml2rfc 3.19.0" name="generator">
<meta content="next generation" name="keyword">
<meta content="unicorn" name="keyword">
<meta content="sparkling distributed ledger" name="keyword">
<meta content="draft-barnes-mimi-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.19.0
    Python 3.11.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 4.1.0
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.2.2
    six 1.16.0
    wcwidth 0.2.12
-->
<link href="draft-barnes-mimi-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI Protocol</td>
<td class="right">January 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Barnes, et al.</td>
<td class="center">Expires 15 July 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-barnes-mimi-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2024-01-12" class="published">12 January 2024</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-07-15">15 July 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. L. Barnes</div>
<div class="org">Cisco</div>
</div>
<div class="author">
      <div class="author-name">M. Hodgson</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Mahy</div>
<div class="org">Wire</div>
</div>
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">More Instant Messaging Interoperability: The Protocol</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://bifurcation.github.io/mimi-protocol/draft-barnes-mimi-protocol.html">https://bifurcation.github.io/mimi-protocol/draft-barnes-mimi-protocol.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-barnes-mimi-protocol/">https://datatracker.ietf.org/doc/draft-barnes-mimi-protocol/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/bifurcation/mimi-protocol">https://github.com/bifurcation/mimi-protocol</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 15 July 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-known-gaps" class="internal xref">Known Gaps</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-protocol-overview" class="internal xref">Protocol Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-alice-creates-a-room" class="internal xref">Alice Creates a Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-alice-adds-bob-to-the-room" class="internal xref">Alice adds Bob to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-bob-adds-cathy-to-the-room" class="internal xref">Bob adds Cathy to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-cathy-sends-a-message" class="internal xref">Cathy Sends a Message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-bob-leaves-the-room" class="internal xref">Bob Leaves the Room</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-identifiers" class="internal xref">Identifiers</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-transport-layer" class="internal xref">Transport layer</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-e2e-security-layer" class="internal xref">E2E Security Layer</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-application-layer" class="internal xref">Application Layer</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-server-state" class="internal xref">Server State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-room-state-changes" class="internal xref">Room State Changes</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="auto internal xref">7.3</a>.  <a href="#name-directory" class="internal xref">Directory</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4" class="auto internal xref">7.4</a>.  <a href="#name-fetch-key-material" class="internal xref">Fetch Key Material</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a href="#section-7.5" class="auto internal xref">7.5</a>.  <a href="#name-update-room-state" class="internal xref">Update Room State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.6">
                <p id="section-toc.1-1.7.2.6.1"><a href="#section-7.6" class="auto internal xref">7.6</a>.  <a href="#name-submit-a-message" class="internal xref">Submit a Message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.7">
                <p id="section-toc.1-1.7.2.7.1"><a href="#section-7.7" class="auto internal xref">7.7</a>.  <a href="#name-fanout-messages-and-room-ev" class="internal xref">Fanout Messages and Room Events</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-use-of-mls-ds-as" class="internal xref">Use of MLS DS/AS</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-mls-application-state-synch" class="internal xref">MLS Application State Synchronization</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-consent" class="internal xref">Consent</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="auto internal xref">13.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="auto internal xref">13.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The goal of the More Instant Messaging Interoperability (MIMI) Working Group is
to enable multiple providers of end-to-end encrypted instant messaging to
interoperate. As described in the MIMI architecture, group chats and direct
messages are described in terms of "rooms". Each MIMI protocol room is hosted at
a single provider (the "hub" provider"), but allows users from different
providers to become participants in the room. The hub provider maintains the
policy and participation for the room, authorizes messages, and is responsible
for message ordering, the participation list, and policy of its rooms. Each
provider also stores initial keying material and consent for its users (who may
be offline).<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes the communication between and among different providers
necessary to send and receive encrypted messages, share room policy, and add
participants to and remove participants from rooms. In support of these
functions, the protocol also has primitives to fetch initial keying material,
fetch the current state of the underlying end-to-end encryption protocol for the
room, and request, grant, and reject consent to communicate with users on other
providers.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">Messages sent inside each room are end-to-end encrypted using the Messaging
Layer Security (MLS) protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, and each room is associated with an
MLS group. MLS also ensures that clients in a room agree on the room policy and
participation. One of the core principles of this protocol is that at all times,
the clients of the end-to-end encryption protocol (the MLS clients who are in an
MLS group) all need to correspond to users who are in the associated room.<a href="#section-1-3" class="pilcrow">¶</a></p>
<div id="known-gaps">
<section id="section-1.1">
        <h3 id="name-known-gaps">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-known-gaps" class="section-name selfRef">Known Gaps</a>
        </h3>
<p id="section-1.1-1">In this version of the document, we have tried to capture enough concrete
functionality to enable basic application functionality, while defining enough
of a protocol framework to indicate how other necessary functionality.  The
following functions are likely to be needed by the complete protocol, but are
not covered here:<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-1.1-2">
          <dt id="section-1.1-2.1">Authorization policy:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.2">
            <p id="section-1.1-2.2.1">In this document, we assume that all participants in a room have equal
capability.  Actual messaging systems have authorization policies for which
clients can take which actions in a room.<a href="#section-1.1-2.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.3">Advanced join/leave flows:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.4">
            <p id="section-1.1-2.4.1">In this document, all adds / removes / joins / leaves are initiated from
within the group, since this aligns well with MLS.  Messaging application
support a variety of other flows, some of which this protocol will need to
support.<a href="#section-1.1-2.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.5">Consent:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.6">
            <p id="section-1.1-2.6.1">In this document, we assume that any required consent has already been
obtained, e.g., a user consenting to be added to a room by another user.  The
full protocol will need some mechanisms for establishing this consent.  Some
initial notes are in <a href="#consent" class="auto internal xref">Section 10</a><a href="#section-1.1-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.7">Identifiers:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.8">
            <p id="section-1.1-2.8.1">Certain entities in the MIMI system need to be identified in the protocol.  In
<a href="#identifiers" class="auto internal xref">Section 4</a>, we define a notional syntax for identifiers, but a more
concrete one should be defined.<a href="#section-1.1-2.8.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.9">Abuse reporting:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.10">
            <p id="section-1.1-2.10.1">There is no mechanism in this document for reporting abusive behavior to a
messaging provider.<a href="#section-1.1-2.10.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.11">Identifier resolution:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.12">
            <p id="section-1.1-2.12.1">In some cases, the identifier used to initiate communications with a user
might be different from the identifier that should be used internally.  For
example, a user-visible handle might need to be mapped to a durable internal
identifier.  This document provides no mechanism for such resolution.<a href="#section-1.1-2.12.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Most MIMI-related terms are inherited from <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>. Readers
of this document should be familiar with the Terminology section of the MLS protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">Throughout this document, the examples use the TLS Presentation Language
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> and the semantics of HTTP <span>[<a href="#RFC7231" class="cite xref">RFC7231</a>]</span> respectively as
placeholders for a binary encoding mechanism and transport semantics.<a href="#section-2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="protocol-overview">
<section id="section-3">
      <h2 id="name-protocol-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
      </h2>
<p id="section-3-1">As shown in <a href="#fig-layers" class="auto internal xref">Figure 1</a>, the overall MIMI protocol is built out of three layers:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3-2">
<li id="section-3-2.1">
          <p id="section-3-2.1.1">An application layer that enables messaging functionality<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-3-2.2">
          <p id="section-3-2.2.1">A security layer that provides end-to-end security guarantees:<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.2.2.1">
              <p id="section-3-2.2.2.1.1">Confidentiality for messages<a href="#section-3-2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3-2.2.2.2">
              <p id="section-3-2.2.2.2.1">Authentication of actors making changes to rooms<a href="#section-3-2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3-2.2.2.3">
              <p id="section-3-2.2.2.3.1">Agreement on room state across the clients involved in a room<a href="#section-3-2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li id="section-3-2.3">
          <p id="section-3-2.3.1">A transport layer that provides secure delivery of protocol objects between
servers.<a href="#section-3-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-3-3">The MIMI transport is based on HTTPS over mutually-authenticated TLS.  MIMI uses
MLS <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span> for end-to-end security, using the MLS AppSync proposal type to
efficiently synchronize room state across the clients involved in a room.<a href="#section-3-3" class="pilcrow">¶</a></p>
<span id="name-mimi-protocol-layering"></span><div id="fig-layers">
<figure id="figure-1">
        <div id="section-3-4.1">
          <div class="alignLeft art-svg artwork" id="section-3-4.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="216" viewBox="0 0 216 144" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,32 L 8,128" fill="none" stroke="black"></path>
              <path d="M 72,64 L 72,96" fill="none" stroke="black"></path>
              <path d="M 208,32 L 208,128" fill="none" stroke="black"></path>
              <path d="M 8,32 L 208,32" fill="none" stroke="black"></path>
              <path d="M 72,64 L 208,64" fill="none" stroke="black"></path>
              <path d="M 8,96 L 208,96" fill="none" stroke="black"></path>
              <path d="M 8,128 L 208,128" fill="none" stroke="black"></path>
              <g class="text">
                <text x="112" y="52">Application</text>
                <text x="104" y="84">E2E</text>
                <text x="156" y="84">Security</text>
                <text x="112" y="116">Transport</text>
              </g>
            </svg><a href="#section-3-4.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-mimi-protocol-layering" class="selfRef">MIMI protocol layering</a>
        </figcaption></figure>
</div>
<p id="section-3-5">The remainder of this section walks through a basic scenario that illustrates
how a room works in the MIMI protocol.  The scenario involves the following
actors:<a href="#section-3-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-6.1">
          <p id="section-3-6.1.1">Service providers <code>a.example</code>, <code>b.example</code>, and <code>c.example</code> represented by
servers <code>ServerA</code>, <code>ServerB</code>, and <code>ServerC</code> respectively<a href="#section-3-6.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.2">
          <p id="section-3-6.2.1">Users Alice (<code>alice@a.example</code>), Bob (<code>bob@b.example</code>) and Cathy
(<code>cathy@c.example</code>) of the respective service providers<a href="#section-3-6.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.3">
          <p id="section-3-6.3.1">Clients <code>ClientA1</code>, <code>ClientA2</code>, <code>ClientB1</code>, etc. belonging to these users<a href="#section-3-6.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.4">
          <p id="section-3-6.4.1">A room <code>clubhouse@a.example</code> where the three users interact<a href="#section-3-6.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-7">As noted in <span>[<a href="#I-D.mimi-arch" class="cite xref">I-D.mimi-arch</a>]</span>, the MIMI protocol only defines interactions
between service providers' servers.  Interactions between clients and servers
within a service provider domain are shown here for completeness, but
surrounded by <code>[[ double brackets ]]</code>.<a href="#section-3-7" class="pilcrow">¶</a></p>
<div id="alice-creates-a-room">
<section id="section-3.1">
        <h3 id="name-alice-creates-a-room">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-alice-creates-a-room" class="section-name selfRef">Alice Creates a Room</a>
        </h3>
<p id="section-3.1-1">The first step in the lifetime of a MIMI room is its creation on the hub server.
This operation is local to the service provider, and does not entail any MIMI
protocol operations.  However, it must establish the initial state of the room,
which is then the basis for protocol operations related to the room.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">Here, we assume that Alice uses ClientA1 to create a room with the following
properties:<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-3.1">
            <p id="section-3.1-3.1.1">Identifier: <code>clubhouse@a.example</code><a href="#section-3.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-3.2">
            <p id="section-3.1-3.2.1">Participants: <code>[alice@a.example]</code><a href="#section-3.1-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-4">ClientA1 also creates an MLS group with group ID <code>clubhouse@a.example</code> and
ensures via provider-local operations that Alice's other clients are members of
this MLS group.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-bob-to-the-room">
<section id="section-3.2">
        <h3 id="name-alice-adds-bob-to-the-room">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-alice-adds-bob-to-the-room" class="section-name selfRef">Alice adds Bob to the Room</a>
        </h3>
<p id="section-3.2-1">Adding Bob to the room entails operations at two levels.  First, Bob's user
identity must be added to the room's participant list.  Second, Bob's clients
must be added to the room's MLS group.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The process of adding Bob to the room thus begins by Alice fetching key material
for Bob's clients.  Alice then updates the room by sending an MLS Commit over
the following proposals:<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2-3.1">
            <p id="section-3.2-3.1.1">An AppSync proposal updating the room state by adding Bob to the
participant list<a href="#section-3.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.2-3.2">
            <p id="section-3.2-3.2.1">Add proposals for Bob's clients<a href="#section-3.2-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.2-4">The MIMI protocol interactions are between Alice's server ServerA and Bob's
server ServerB.  ServerB stores KeyPackages on behalf of Bob's devices.  ServerA
performs the key material fetch on Alice's behalf, and delivers the resulting
KeyPackages to Alice's clients.  Both ServerA and ServerB remember the sources
of the KeyPackages they handle, so that they can route a Welcome mesasage for
those KeyPackages to the proper recipients -- ServerA to ServerB, and ServerB to
Bob's clients.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
<p id="section-3.2-5">[[ NOTE: In the full protocol, it will be necessary to have consent and access
control on these operations.  We have elided that step here in the interest of
simplicity.  Some initial thoughts are in <a href="#consent" class="auto internal xref">Section 10</a> ]]<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<span id="name-alice-fetches-keypackages-f"></span><div id="fig-ab-kp-fetch">
<figure id="figure-2">
          <div id="section-3.2-6.1">
            <div class="alignLeft art-svg artwork" id="section-3.2-6.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="496" viewBox="0 0 496 368" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,208" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,208" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,208" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,208" fill="none" stroke="black"></path>
                <path d="M 152,144 L 272,144" fill="none" stroke="black"></path>
                <path d="M 160,176 L 280,176" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="280,144 268,138.4 268,149.6" fill="black" transform="rotate(0,272,144)"></polygon>
                <polygon class="arrowhead" points="168,176 156,170.4 156,181.6" fill="black" transform="rotate(180,160,176)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientA1</text>
                  <text x="152" y="36">ServerA</text>
                  <text x="280" y="36">ServerB</text>
                  <text x="412" y="36">ClientB*</text>
                  <text x="344" y="68">Store</text>
                  <text x="384" y="68">KPs</text>
                  <text x="344" y="84">&lt;~~~~~~~~~~~~~~</text>
                  <text x="344" y="100">&lt;~~~~~~~~~~~~~~</text>
                  <text x="64" y="116">Request</text>
                  <text x="112" y="116">KPs</text>
                  <text x="88" y="132">~~~~~~~~~~~~~~&gt;</text>
                  <text x="212" y="132">/keyMaterial</text>
                  <text x="232" y="164">200</text>
                  <text x="260" y="164">OK</text>
                  <text x="128" y="180">KPs</text>
                  <text x="88" y="196">&lt;~~~~~~~~~~~~~~</text>
                  <text x="76" y="244">ClientB*-&gt;ServerB:</text>
                  <text x="164" y="244">[[</text>
                  <text x="200" y="244">Store</text>
                  <text x="272" y="244">KeyPackages</text>
                  <text x="332" y="244">]]</text>
                  <text x="76" y="260">ClientA1-&gt;ServerA:</text>
                  <text x="164" y="260">[[</text>
                  <text x="208" y="260">request</text>
                  <text x="256" y="260">KPs</text>
                  <text x="288" y="260">for</text>
                  <text x="360" y="260">bob@b.example</text>
                  <text x="428" y="260">]]</text>
                  <text x="72" y="276">ServerA-&gt;ServerB:</text>
                  <text x="164" y="276">POST</text>
                  <text x="236" y="276">/keyMaterial</text>
                  <text x="364" y="276">KeyMaterialRequest</text>
                  <text x="36" y="292">ServerB:</text>
                  <text x="100" y="292">Verify</text>
                  <text x="148" y="292">that</text>
                  <text x="192" y="292">Alice</text>
                  <text x="228" y="292">is</text>
                  <text x="284" y="292">authorized</text>
                  <text x="340" y="292">to</text>
                  <text x="376" y="292">fetch</text>
                  <text x="448" y="292">KeyPackages</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="92" y="308">Mark</text>
                  <text x="148" y="308">returned</text>
                  <text x="200" y="308">KPs</text>
                  <text x="228" y="308">as</text>
                  <text x="276" y="308">reserved</text>
                  <text x="328" y="308">for</text>
                  <text x="376" y="308">Alice’s</text>
                  <text x="424" y="308">use</text>
                  <text x="72" y="324">ServerB-&gt;ServerA:</text>
                  <text x="160" y="324">200</text>
                  <text x="188" y="324">OK</text>
                  <text x="280" y="324">KeyMaterialResponse</text>
                  <text x="36" y="340">ServerA:</text>
                  <text x="108" y="340">Remember</text>
                  <text x="164" y="340">that</text>
                  <text x="208" y="340">these</text>
                  <text x="248" y="340">KPs</text>
                  <text x="276" y="340">go</text>
                  <text x="300" y="340">to</text>
                  <text x="352" y="340">b.example</text>
                  <text x="76" y="356">ServerA-&gt;ClientA1:</text>
                  <text x="164" y="356">[[</text>
                  <text x="192" y="356">KPs</text>
                  <text x="220" y="356">]]</text>
                </g>
              </svg><a href="#section-3.2-6.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-alice-fetches-keypackages-f" class="selfRef">Alice Fetches KeyPackages for Bob's Clients</a>
          </figcaption></figure>
</div>
<span id="name-alice-adds-bob-to-the-room-"></span><div id="fig-ab-add">
<figure id="figure-3">
          <div id="section-3.2-7.1">
            <div class="alignLeft art-svg artwork" id="section-3.2-7.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="336" width="656" viewBox="0 0 656 336" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,192" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,192" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,192" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,192" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,160 L 280,160" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,160 156,154.4 156,165.6" fill="black" transform="rotate(180,160,160)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientA1</text>
                  <text x="152" y="36">ServerA</text>
                  <text x="280" y="36">ServerB</text>
                  <text x="412" y="36">ClientB*</text>
                  <text x="64" y="68">Commit,</text>
                  <text x="116" y="68">etc.</text>
                  <text x="88" y="84">~~~~~~~~~~~~~~&gt;</text>
                  <text x="192" y="84">/notify</text>
                  <text x="324" y="100">Welcome,</text>
                  <text x="380" y="100">Tree</text>
                  <text x="344" y="116">~~~~~~~~~~~~~~&gt;</text>
                  <text x="344" y="132">~~~~~~~~~~~~~~&gt;</text>
                  <text x="232" y="148">200</text>
                  <text x="260" y="148">OK</text>
                  <text x="108" y="164">Accepted</text>
                  <text x="88" y="180">&lt;~~~~~~~~~~~~~~</text>
                  <text x="40" y="228">ClientA1:</text>
                  <text x="112" y="228">Prepare</text>
                  <text x="172" y="228">Commit</text>
                  <text x="220" y="228">over</text>
                  <text x="340" y="228">AppSync(+bob@b.example),</text>
                  <text x="460" y="228">Add*</text>
                  <text x="76" y="244">ClientA1-&gt;ServerA:</text>
                  <text x="164" y="244">[[</text>
                  <text x="208" y="244">Commit,</text>
                  <text x="276" y="244">Welcome,</text>
                  <text x="360" y="244">GroupInfo?,</text>
                  <text x="460" y="244">RatchetTree?</text>
                  <text x="524" y="244">]]</text>
                  <text x="36" y="260">ServerA:</text>
                  <text x="100" y="260">Verify</text>
                  <text x="148" y="260">that</text>
                  <text x="204" y="260">AppSync,</text>
                  <text x="260" y="260">Adds</text>
                  <text x="296" y="260">are</text>
                  <text x="344" y="260">allowed</text>
                  <text x="388" y="260">by</text>
                  <text x="428" y="260">policy</text>
                  <text x="36" y="276">ServerA:</text>
                  <text x="116" y="276">Identifies</text>
                  <text x="192" y="276">Welcome</text>
                  <text x="256" y="276">domains</text>
                  <text x="312" y="276">based</text>
                  <text x="348" y="276">on</text>
                  <text x="372" y="276">KP</text>
                  <text x="404" y="276">hash</text>
                  <text x="436" y="276">in</text>
                  <text x="480" y="276">Welcome</text>
                  <text x="72" y="292">ServerA-&gt;ServerB:</text>
                  <text x="164" y="292">POST</text>
                  <text x="296" y="292">/notify/clubhouse@a.example</text>
                  <text x="436" y="292">Intro{</text>
                  <text x="500" y="292">Welcome,</text>
                  <text x="588" y="292">RatchetTree?</text>
                  <text x="648" y="292">}</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="116" y="308">Recognizes</text>
                  <text x="180" y="308">that</text>
                  <text x="232" y="308">Welcome</text>
                  <text x="276" y="308">is</text>
                  <text x="316" y="308">adding</text>
                  <text x="360" y="308">Bob</text>
                  <text x="388" y="308">to</text>
                  <text x="420" y="308">room</text>
                  <text x="520" y="308">clubhouse@a.example</text>
                  <text x="76" y="324">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="324">[[</text>
                  <text x="212" y="324">Welcome,</text>
                  <text x="300" y="324">RatchetTree?</text>
                  <text x="364" y="324">]]</text>
                </g>
              </svg><a href="#section-3.2-7.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-alice-adds-bob-to-the-room-" class="selfRef">Alice Adds Bob to the Room and Bob's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-adds-cathy-to-the-room">
<section id="section-3.3">
        <h3 id="name-bob-adds-cathy-to-the-room">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-bob-adds-cathy-to-the-room" class="section-name selfRef">Bob adds Cathy to the Room</a>
        </h3>
<p id="section-3.3-1">The process of adding Bob was a bit abbreviated because Alice is a user of the
hub service provider.  When Bob adds Cathy, we see the full process, involving
the same two steps (KP fetch followed by add), but this time indirected via the
hub server ServerA.  Also, now that there are users on ServerB involved in the
room, the hub ServerA will have to distribute the Commit adding Cathy and
Cathy's clients to ServerB as well as forwarding the Welcome to ServerC.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<span id="name-bob-fetches-keypackages-for"></span><div id="fig-bc-kp-fetch">
<figure id="figure-4">
          <div id="section-3.3-2.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="400" width="576" viewBox="0 0 576 400" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,208" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,208" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,208" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,208" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,208" fill="none" stroke="black"></path>
                <path d="M 152,144 L 400,144" fill="none" stroke="black"></path>
                <path d="M 160,176 L 408,176" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="408,144 396,138.4 396,149.6" fill="black" transform="rotate(0,400,144)"></polygon>
                <polygon class="arrowhead" points="296,176 284,170.4 284,181.6" fill="black" transform="rotate(180,288,176)"></polygon>
                <polygon class="arrowhead" points="280,144 268,138.4 268,149.6" fill="black" transform="rotate(0,272,144)"></polygon>
                <polygon class="arrowhead" points="168,176 156,170.4 156,181.6" fill="black" transform="rotate(180,160,176)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientB1</text>
                  <text x="152" y="36">ServerB</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerC</text>
                  <text x="540" y="36">ClientC*</text>
                  <text x="472" y="68">Store</text>
                  <text x="512" y="68">KPs</text>
                  <text x="472" y="84">&lt;~~~~~~~~~~~~~~</text>
                  <text x="472" y="100">&lt;~~~~~~~~~~~~~~</text>
                  <text x="64" y="116">Request</text>
                  <text x="112" y="116">KPs</text>
                  <text x="88" y="132">~~~~~~~~~~~~~~&gt;</text>
                  <text x="212" y="132">/keyMaterial</text>
                  <text x="340" y="132">/keyMaterial</text>
                  <text x="232" y="164">200</text>
                  <text x="260" y="164">OK</text>
                  <text x="360" y="164">200</text>
                  <text x="388" y="164">OK</text>
                  <text x="128" y="180">KPs</text>
                  <text x="88" y="196">&lt;~~~~~~~~~~~~~~</text>
                  <text x="76" y="244">ClientC*-&gt;ServerC:</text>
                  <text x="164" y="244">[[</text>
                  <text x="200" y="244">Store</text>
                  <text x="272" y="244">KeyPackages</text>
                  <text x="332" y="244">]]</text>
                  <text x="76" y="260">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="260">[[</text>
                  <text x="208" y="260">request</text>
                  <text x="256" y="260">KPs</text>
                  <text x="288" y="260">for</text>
                  <text x="360" y="260">bob@b.example</text>
                  <text x="428" y="260">]]</text>
                  <text x="72" y="276">ServerB-&gt;ServerA:</text>
                  <text x="164" y="276">POST</text>
                  <text x="236" y="276">/keyMaterial</text>
                  <text x="364" y="276">KeyMaterialRequest</text>
                  <text x="72" y="292">ServerA-&gt;ServerC:</text>
                  <text x="164" y="292">POST</text>
                  <text x="236" y="292">/keyMaterial</text>
                  <text x="364" y="292">KeyMaterialRequest</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="100" y="308">Verify</text>
                  <text x="148" y="308">that</text>
                  <text x="184" y="308">Bob</text>
                  <text x="212" y="308">is</text>
                  <text x="268" y="308">authorized</text>
                  <text x="324" y="308">to</text>
                  <text x="360" y="308">fetch</text>
                  <text x="432" y="308">KeyPackages</text>
                  <text x="36" y="324">ServerB:</text>
                  <text x="92" y="324">Mark</text>
                  <text x="148" y="324">returned</text>
                  <text x="200" y="324">KPs</text>
                  <text x="228" y="324">as</text>
                  <text x="276" y="324">reserved</text>
                  <text x="328" y="324">for</text>
                  <text x="368" y="324">Bob’s</text>
                  <text x="408" y="324">use</text>
                  <text x="72" y="340">ServerC-&gt;ServerA:</text>
                  <text x="160" y="340">200</text>
                  <text x="188" y="340">OK</text>
                  <text x="280" y="340">KeyMaterialResponse</text>
                  <text x="36" y="356">ServerA:</text>
                  <text x="108" y="356">Remember</text>
                  <text x="164" y="356">that</text>
                  <text x="208" y="356">these</text>
                  <text x="248" y="356">KPs</text>
                  <text x="276" y="356">go</text>
                  <text x="300" y="356">to</text>
                  <text x="352" y="356">b.example</text>
                  <text x="72" y="372">ServerA-&gt;ServerB:</text>
                  <text x="160" y="372">200</text>
                  <text x="188" y="372">OK</text>
                  <text x="280" y="372">KeyMaterialResponse</text>
                  <text x="76" y="388">ServerB-&gt;ClientB1:</text>
                  <text x="164" y="388">[[</text>
                  <text x="192" y="388">KPs</text>
                  <text x="220" y="388">]]</text>
                </g>
              </svg><a href="#section-3.3-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-bob-fetches-keypackages-for" class="selfRef">Bob Fetches KeyPackages for Cathy's Clients</a>
          </figcaption></figure>
</div>
<span id="name-bob-adds-cathy-to-the-room-"></span><div id="fig-bc-add">
<figure id="figure-5">
          <div id="section-3.3-3.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-3.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="512" width="736" viewBox="0 0 736 512" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,304" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,304" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,240" fill="none" stroke="black"></path>
                <path d="M 280,272 L 280,304" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,240" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,240" fill="none" stroke="black"></path>
                <path d="M 616,48 L 616,272" fill="none" stroke="black"></path>
                <path d="M 696,48 L 696,304" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,128 L 280,128" fill="none" stroke="black"></path>
                <path d="M 280,160 L 400,160" fill="none" stroke="black"></path>
                <path d="M 160,224 L 280,224" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,224 156,218.4 156,229.6" fill="black" transform="rotate(180,160,224)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(180,160,128)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientB1</text>
                  <text x="152" y="36">ServerB</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerC</text>
                  <text x="540" y="36">ClientC*</text>
                  <text x="620" y="36">ClientB*</text>
                  <text x="700" y="36">ClientA*</text>
                  <text x="64" y="68">Commit,</text>
                  <text x="116" y="68">etc.</text>
                  <text x="88" y="84">~~~~~~~~~~~~~~&gt;</text>
                  <text x="192" y="84">/update</text>
                  <text x="232" y="116">200</text>
                  <text x="260" y="116">OK</text>
                  <text x="108" y="148">Accepted</text>
                  <text x="320" y="148">/notify</text>
                  <text x="88" y="164">&lt;~~~~~~~~~~~~~~</text>
                  <text x="452" y="164">Welcome,</text>
                  <text x="508" y="164">Tree</text>
                  <text x="472" y="180">~~~~~~~~~~~~~~&gt;</text>
                  <text x="472" y="196">~~~~~~~~~~~~~~&gt;</text>
                  <text x="240" y="212">/notify</text>
                  <text x="188" y="244">Commit</text>
                  <text x="384" y="260">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;</text>
                  <text x="316" y="276">Commit</text>
                  <text x="408" y="276">|</text>
                  <text x="536" y="276">|</text>
                  <text x="488" y="292">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;</text>
                  <text x="408" y="308">|</text>
                  <text x="536" y="308">|</text>
                  <text x="616" y="308">|</text>
                  <text x="40" y="340">ClientB1:</text>
                  <text x="112" y="340">Prepare</text>
                  <text x="172" y="340">Commit</text>
                  <text x="220" y="340">over</text>
                  <text x="348" y="340">AppSync(+cathy@c.example),</text>
                  <text x="476" y="340">Add*</text>
                  <text x="76" y="356">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="356">[[</text>
                  <text x="208" y="356">Commit,</text>
                  <text x="276" y="356">Welcome,</text>
                  <text x="360" y="356">GroupInfo?,</text>
                  <text x="460" y="356">RatchetTree?</text>
                  <text x="524" y="356">]]</text>
                  <text x="72" y="372">ServerB-&gt;ServerA:</text>
                  <text x="164" y="372">POST</text>
                  <text x="296" y="372">/update/clubhouse@a.example</text>
                  <text x="460" y="372">CommitBundle</text>
                  <text x="36" y="388">ServerA:</text>
                  <text x="100" y="388">Verify</text>
                  <text x="148" y="388">that</text>
                  <text x="188" y="388">Adds</text>
                  <text x="224" y="388">are</text>
                  <text x="272" y="388">allowed</text>
                  <text x="316" y="388">by</text>
                  <text x="356" y="388">policy</text>
                  <text x="72" y="404">ServerA-&gt;ServerB:</text>
                  <text x="160" y="404">200</text>
                  <text x="188" y="404">OK</text>
                  <text x="72" y="420">ServerA-&gt;ServerC:</text>
                  <text x="164" y="420">POST</text>
                  <text x="296" y="420">/notify/clubhouse@a.example</text>
                  <text x="436" y="420">Intro{</text>
                  <text x="500" y="420">Welcome,</text>
                  <text x="588" y="420">RatchetTree?</text>
                  <text x="648" y="420">}</text>
                  <text x="36" y="436">ServerC:</text>
                  <text x="116" y="436">Recognizes</text>
                  <text x="180" y="436">that</text>
                  <text x="232" y="436">Welcome</text>
                  <text x="276" y="436">is</text>
                  <text x="316" y="436">adding</text>
                  <text x="368" y="436">Cathy</text>
                  <text x="404" y="436">to</text>
                  <text x="496" y="436">clubhouse@a.example</text>
                  <text x="76" y="452">ServerC-&gt;ClientC*:</text>
                  <text x="164" y="452">[[</text>
                  <text x="212" y="452">Welcome,</text>
                  <text x="300" y="452">RatchetTree?</text>
                  <text x="364" y="452">]]</text>
                  <text x="72" y="468">ServerA-&gt;ServerB:</text>
                  <text x="164" y="468">POST</text>
                  <text x="296" y="468">/notify/clubhouse@a.example</text>
                  <text x="436" y="468">Commit</text>
                  <text x="76" y="484">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="484">[[</text>
                  <text x="204" y="484">Commit</text>
                  <text x="244" y="484">]]</text>
                  <text x="76" y="500">ServerA-&gt;ClientA*:</text>
                  <text x="164" y="500">[[</text>
                  <text x="204" y="500">Commit</text>
                  <text x="244" y="500">]]</text>
                </g>
              </svg><a href="#section-3.3-3.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-bob-adds-cathy-to-the-room-" class="selfRef">Bob Adds Cathy to the Room and Cathy's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="cathy-sends-a-message">
<section id="section-3.4">
        <h3 id="name-cathy-sends-a-message">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-cathy-sends-a-message" class="section-name selfRef">Cathy Sends a Message</a>
        </h3>
<p id="section-3.4-1">Now that Alice, Bob, and Cathy are all in the room, Cathy wants to say hello to
everyone.  Cathy's client encapsulates the message in an MLS PrivateMessage and
sends it to ServerC, who forwards it to the hub ServerA on Cathy's behalf.
Assuming Cathy is allowed to speak in the room, ServerA will forward Cathy's
message to the other servers involved in the room, who distribute it to their
clients.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<span id="name-cathy-sends-a-message-to-th"></span><div id="fig-c-msg">
<figure id="figure-6">
          <div id="section-3.4-2.1">
            <div class="alignLeft art-svg artwork" id="section-3.4-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="448" width="736" viewBox="0 0 736 448" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,288" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,288" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,224" fill="none" stroke="black"></path>
                <path d="M 280,256 L 280,288" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,224" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,224" fill="none" stroke="black"></path>
                <path d="M 616,48 L 616,256" fill="none" stroke="black"></path>
                <path d="M 696,48 L 696,288" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,128 L 280,128" fill="none" stroke="black"></path>
                <path d="M 280,160 L 400,160" fill="none" stroke="black"></path>
                <path d="M 160,208 L 280,208" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,208 156,202.4 156,213.6" fill="black" transform="rotate(180,160,208)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(180,160,128)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientC1</text>
                  <text x="152" y="36">ServerC</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerB</text>
                  <text x="540" y="36">ClientB*</text>
                  <text x="620" y="36">ClientC*</text>
                  <text x="700" y="36">ClientA*</text>
                  <text x="64" y="68">Message</text>
                  <text x="88" y="84">~~~~~~~~~~~~~~&gt;</text>
                  <text x="192" y="84">/submit</text>
                  <text x="232" y="116">200</text>
                  <text x="260" y="116">OK</text>
                  <text x="108" y="148">Accepted</text>
                  <text x="320" y="148">/notify</text>
                  <text x="88" y="164">&lt;~~~~~~~~~~~~~~</text>
                  <text x="448" y="164">Message</text>
                  <text x="472" y="180">~~~~~~~~~~~~~~&gt;</text>
                  <text x="240" y="196">/notify</text>
                  <text x="192" y="228">Message</text>
                  <text x="384" y="244">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;</text>
                  <text x="320" y="260">Message</text>
                  <text x="408" y="260">|</text>
                  <text x="536" y="260">|</text>
                  <text x="488" y="276">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;</text>
                  <text x="408" y="292">|</text>
                  <text x="536" y="292">|</text>
                  <text x="616" y="292">|</text>
                  <text x="76" y="324">ClientC1-&gt;ServerC:</text>
                  <text x="164" y="324">[[</text>
                  <text x="284" y="324">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="324">]]</text>
                  <text x="72" y="340">ServerC-&gt;ServerA:</text>
                  <text x="164" y="340">POST</text>
                  <text x="296" y="340">/submit/clubhouse@a.example</text>
                  <text x="516" y="340">MLSMessage(PrivateMessage)</text>
                  <text x="36" y="356">ServerA:</text>
                  <text x="108" y="356">Verifies</text>
                  <text x="164" y="356">that</text>
                  <text x="216" y="356">message</text>
                  <text x="260" y="356">is</text>
                  <text x="304" y="356">allowed</text>
                  <text x="72" y="372">ServerA-&gt;ServerC:</text>
                  <text x="164" y="372">POST</text>
                  <text x="296" y="372">/notify/clubhouse@a.example</text>
                  <text x="444" y="372">Message{</text>
                  <text x="588" y="372">MLSMessage(PrivateMessage)</text>
                  <text x="704" y="372">}</text>
                  <text x="72" y="388">ServerA-&gt;ServerB:</text>
                  <text x="164" y="388">POST</text>
                  <text x="296" y="388">/notify/clubhouse@a.example</text>
                  <text x="444" y="388">Message{</text>
                  <text x="588" y="388">MLSMessage(PrivateMessage)</text>
                  <text x="704" y="388">}</text>
                  <text x="76" y="404">ServerA-&gt;ClientA*:</text>
                  <text x="164" y="404">[[</text>
                  <text x="284" y="404">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="404">]]</text>
                  <text x="76" y="420">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="420">[[</text>
                  <text x="284" y="420">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="420">]]</text>
                  <text x="76" y="436">ServerC-&gt;ClientC*:</text>
                  <text x="164" y="436">[[</text>
                  <text x="284" y="436">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="436">]]</text>
                </g>
              </svg><a href="#section-3.4-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-cathy-sends-a-message-to-th" class="selfRef">Cathy Sends a Message to the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-leaves-the-room">
<section id="section-3.5">
        <h3 id="name-bob-leaves-the-room">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-bob-leaves-the-room" class="section-name selfRef">Bob Leaves the Room</a>
        </h3>
<p id="section-3.5-1">A user removing another user follows the same flow as adding the user.  The
user performing the removal creates an MLS commit covering Remove proposals for
all of the removed user's devices, and an AppSync proposal updating the room
state to remove the removed user from the room's participant list.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">Leaving is slightly more complicated because the leaving user cannot remove all
of their devices from the MLS group.  Instead, the leave happens in three steps:<a href="#section-3.5-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.5-3">
<li id="section-3.5-3.1">
            <p id="section-3.5-3.1.1">The leaving client constructs MLS Remove proposals for all of the user's
devices (including the leaving client), and an AppSync proposal that removes
its user from the participant list.<a href="#section-3.5-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.2">
            <p id="section-3.5-3.2.1">The leaving client sends this proposals to the hub.  The hub caches the proposals.<a href="#section-3.5-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.3">
            <p id="section-3.5-3.3.1">The next time a client attempts to commit, the hub requires the client to
include the cached proposals.<a href="#section-3.5-3.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-3.5-4">The hub thus guarantees the leaving client that they will be removed as soon as
possible.<a href="#section-3.5-4" class="pilcrow">¶</a></p>
<span id="name-bob-leaves-the-room-2"></span><div id="fig-b-leave">
<figure id="figure-7">
          <div id="section-3.5-5.1">
            <div class="alignLeft art-svg artwork" id="section-3.5-5.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="624" width="592" viewBox="0 0 592 624" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,384" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,384" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,384" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,384" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,384" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,128 L 280,128" fill="none" stroke="black"></path>
                <path d="M 280,160 L 400,160" fill="none" stroke="black"></path>
                <path d="M 288,272 L 408,272" fill="none" stroke="black"></path>
                <path d="M 280,304 L 400,304" fill="none" stroke="black"></path>
                <path d="M 160,368 L 400,368" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="408,368 396,362.4 396,373.6" fill="black" transform="rotate(0,400,368)"></polygon>
                <polygon class="arrowhead" points="408,304 396,298.4 396,309.6" fill="black" transform="rotate(0,400,304)"></polygon>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="296,272 284,266.4 284,277.6" fill="black" transform="rotate(180,288,272)"></polygon>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,368 156,362.4 156,373.6" fill="black" transform="rotate(180,160,368)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(180,160,128)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientB1</text>
                  <text x="152" y="36">ServerB</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerC</text>
                  <text x="540" y="36">ClientC1</text>
                  <text x="72" y="68">Proposals</text>
                  <text x="88" y="84">~~~~~~~~~~~~~~&gt;</text>
                  <text x="192" y="84">/update</text>
                  <text x="232" y="116">200</text>
                  <text x="260" y="116">OK</text>
                  <text x="108" y="148">Accepted</text>
                  <text x="328" y="148">/notify</text>
                  <text x="88" y="164">&lt;~~~~~~~~~~~~~~</text>
                  <text x="456" y="180">Proposals</text>
                  <text x="472" y="196">~~~~~~~~~~~~~~&gt;</text>
                  <text x="472" y="228">Commit(Props)</text>
                  <text x="472" y="244">&lt;~~~~~~~~~~~~~~</text>
                  <text x="368" y="260">/update</text>
                  <text x="304" y="292">200</text>
                  <text x="332" y="292">OK</text>
                  <text x="452" y="324">Accepted</text>
                  <text x="472" y="340">~~~~~~~~~~~~~~&gt;</text>
                  <text x="240" y="356">/notify</text>
                  <text x="320" y="356">/notify</text>
                  <text x="40" y="420">ClientB1:</text>
                  <text x="112" y="420">Prepare</text>
                  <text x="180" y="420">Remove*,</text>
                  <text x="312" y="420">AppSync(-bob@b.example)</text>
                  <text x="76" y="436">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="436">[[</text>
                  <text x="212" y="436">Remove*,</text>
                  <text x="280" y="436">AppSync</text>
                  <text x="324" y="436">]]</text>
                  <text x="72" y="452">ServerB-&gt;ServerA:</text>
                  <text x="164" y="452">POST</text>
                  <text x="296" y="452">/update/clubhouse@a.example</text>
                  <text x="444" y="452">Remove*,</text>
                  <text x="512" y="452">AppSync</text>
                  <text x="36" y="468">ServerA:</text>
                  <text x="100" y="468">Verify</text>
                  <text x="148" y="468">that</text>
                  <text x="204" y="468">Removes,</text>
                  <text x="272" y="468">AppSync</text>
                  <text x="320" y="468">are</text>
                  <text x="368" y="468">allowed</text>
                  <text x="412" y="468">by</text>
                  <text x="456" y="468">policy;</text>
                  <text x="512" y="468">cache</text>
                  <text x="72" y="484">ServerA-&gt;ServerB:</text>
                  <text x="160" y="484">200</text>
                  <text x="188" y="484">OK</text>
                  <text x="72" y="500">ServerA-&gt;ServerC:</text>
                  <text x="164" y="500">POST</text>
                  <text x="296" y="500">/notify/clubhouse@a.example</text>
                  <text x="448" y="500">Proposals</text>
                  <text x="80" y="516">ServerC1-&gt;ClientC1:</text>
                  <text x="172" y="516">[[</text>
                  <text x="224" y="516">Proposals</text>
                  <text x="276" y="516">]]</text>
                  <text x="76" y="532">ClientC1-&gt;ServerC:</text>
                  <text x="164" y="532">[[</text>
                  <text x="236" y="532">Commit(Props),</text>
                  <text x="332" y="532">Welcome,</text>
                  <text x="416" y="532">GroupInfo?,</text>
                  <text x="516" y="532">RatchetTree?</text>
                  <text x="580" y="532">]]</text>
                  <text x="72" y="548">ServerC-&gt;ServerA:</text>
                  <text x="164" y="548">POST</text>
                  <text x="296" y="548">/update/clubhouse@a.example</text>
                  <text x="460" y="548">CommitBundle</text>
                  <text x="36" y="564">ServerA:</text>
                  <text x="96" y="564">Check</text>
                  <text x="152" y="564">whether</text>
                  <text x="212" y="564">Commit</text>
                  <text x="276" y="564">includes</text>
                  <text x="340" y="564">queued</text>
                  <text x="412" y="564">proposals;</text>
                  <text x="484" y="564">accept</text>
                  <text x="72" y="580">ServerA-&gt;ServerC:</text>
                  <text x="160" y="580">200</text>
                  <text x="188" y="580">OK</text>
                  <text x="72" y="596">ServerA-&gt;ServerB:</text>
                  <text x="164" y="596">POST</text>
                  <text x="296" y="596">/notify/clubhouse@a.example</text>
                  <text x="436" y="596">Commit</text>
                  <text x="72" y="612">ServerA-&gt;ServerC:</text>
                  <text x="164" y="612">POST</text>
                  <text x="296" y="612">/notify/clubhouse@a.example</text>
                  <text x="436" y="612">Commit</text>
                </g>
              </svg><a href="#section-3.5-5.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-bob-leaves-the-room-2" class="selfRef">Bob Leaves the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
</section>
</div>
<div id="identifiers">
<section id="section-4">
      <h2 id="name-identifiers">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-identifiers" class="section-name selfRef">Identifiers</a>
      </h2>
<p id="section-4-1">Four types of entity need to be identified in the MIMI protocol:<a href="#section-4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4-2">
<li id="section-4-2.1">
          <p id="section-4-2.1.1">Messaging providers<a href="#section-4-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-4-2.2">
          <p id="section-4-2.2.1">Users<a href="#section-4-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-4-2.3">
          <p id="section-4-2.3.1">Rooms<a href="#section-4-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-4-2.4">
          <p id="section-4-2.4.1">MLS groups (in the MLS group ID field)<a href="#section-4-2.4.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-4-3">Messaging providers are identified by domain name.  The remaining identifier
types are domain-scoped, where the domain represents the messaging provider
hosting a user or room.  MLS groups use the same identifier as the room to which
they are attached.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">There are several options for the precise syntax for these identifiers, as
discussed in <span>[<a href="#I-D.mahy-mimi-identity" class="cite xref">I-D.mahy-mimi-identity</a>]</span>.  For purposes of this document, we use
the following notional syntax:<a href="#section-4-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-5.1">
          <p id="section-4-5.1.1">Messaging providers: <code>a.example</code><a href="#section-4-5.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-5.2">
          <p id="section-4-5.2.1">Users: <code>alice@a.example</code><a href="#section-4-5.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-5.3">
          <p id="section-4-5.3.1">Rooms: <code>clubhouse@a.example</code><a href="#section-4-5.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-5.4">
          <p id="section-4-5.4.1">MLS groups: <code>clubhouse@a.example</code><a href="#section-4-5.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="transport-layer">
<section id="section-5">
      <h2 id="name-transport-layer">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-transport-layer" class="section-name selfRef">Transport layer</a>
      </h2>
<p id="section-5-1">MIMI servers communicate using HTTPS.  The HTTP request <span class="bcp14">MUST</span> identify the
source and target providers for the request, in the following way:<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-2.1">
          <p id="section-5-2.1.1">The target provider is indicated using a Host header <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.  If the
provider is using a non-standard port, then the port component of the Host
header is ignored.<a href="#section-5-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-2.2">
          <p id="section-5-2.2.1">The source provider is indicated using a From header <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.  The
<code>mailbox</code> production in the From header <span class="bcp14">MUST</span> use the <code>addr-spec</code> variant, and
the <code>local-part</code> of the address <span class="bcp14">MUST</span> contain the fixed string <code>mimi</code>.  Thus,
the content of the From header will be <code>mimi@a.example</code>, where <code>a.example</code> is
the domain name of the source provider.<a href="#section-5-2.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-5-3">The TLS connection underlying the HTTPS connection <span class="bcp14">MUST</span> be mutually
authenticated.  The certificates presented in the TLS handshake <span class="bcp14">MUST</span>
authenticate the source and target provider domains, according to <span>[<a href="#RFC6125" class="cite xref">RFC6125</a>]</span>.<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">The bodies of HTTP requests and responses are defined by the individual
endpoints defined in <a href="#application-layer" class="auto internal xref">Section 7</a>.<a href="#section-5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="e2e-security-layer">
<section id="section-6">
      <h2 id="name-e2e-security-layer">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-e2e-security-layer" class="section-name selfRef">E2E Security Layer</a>
      </h2>
<p id="section-6-1">Every MIMI room has an MLS group associated to it, which provides end-to-end
security guarantees.  The clients participating in the room manage the MLS-level
membership by sending Commit messages covering Add and Remove proposals.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">Every message sent within a room is authenticated and confidentiality-protected
by virtue of being encapsulated in an MLS PrivateMessage object.<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3">MIMI uses the MLS application state synchronization mechanism
(<a href="#mls-application-state-synchronization" class="auto internal xref">Section 9</a>) to ensure that the clients involved
in a MIMI room agree on the state of the room.  Each MIMI message that changes
the state of the room is encapsulated in an AppSync proposal and transmitted
inside an MLS PublicMessage object.<a href="#section-6-3" class="pilcrow">¶</a></p>
<p id="section-6-4">The PublicMessage encapsulation provides sender authentication, including the
ability for actors outside the group (e.g., servers involved in the room) to
originate AppSync proposals.  Encoding room state changes in MLS proposals
ensures that a client will not process a commit that confirms a state change
before processing the state change itself.<a href="#section-6-4" class="pilcrow">¶</a></p>
<p id="section-6-5">[[ TODO: A little more needs to be said here about how MLS is used.  For
example: What types of credential are required / allowed?  If servers are going
to be allowed to introduce room changes, how are their keys provisioned as
external signers? ]]<a href="#section-6-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="application-layer">
<section id="section-7">
      <h2 id="name-application-layer">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-application-layer" class="section-name selfRef">Application Layer</a>
      </h2>
<p id="section-7-1">Servers in MIMI provide a few functions that enable messaging applications.
All servers act as publication points for key material used to add their users
to rooms. The hub server for a room tracks the state of the room, and controls
how the room's state evolves, e.g., by ensuring that changes are compliant with
the room's policy. Non-hub servers facilitate interactions between their clients
and the hub server.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">In this section, we describe the state that servers keep and the HTTP endpoints
they expose to enable these functions.<a href="#section-7-2" class="pilcrow">¶</a></p>
<div id="server-state">
<section id="section-7.1">
        <h3 id="name-server-state">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-server-state" class="section-name selfRef">Server State</a>
        </h3>
<p id="section-7.1-1">Every MIMI server is a publication point for users' key material, via the
<code>keyMaterial</code> endpoint discussed in <a href="#fetch-key-material" class="auto internal xref">Section 7.4</a>.  To support this
endpoint, the server stores a set of KeyPackages, where each KeyPackage belongs
to a specific user and device.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">The hub server for the room stores the state of the room, comprising:<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.1-3.1">
            <p id="section-7.1-3.1.1">A list of user identifiers for users who are members of the room<a href="#section-7.1-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-7.1-4">[[ NOTE: This state is clearly not sufficient.  We need a more full description
of the room. ]]<a href="#section-7.1-4" class="pilcrow">¶</a></p>
<p id="section-7.1-5">When a client requests key material via the hub, the hub records the
KeyPackageRef values for the returned KeyPackages, and the identity of the
provider from which they were received.  This information is then used to route
Welcome message to the proper provider.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-state-changes">
<section id="section-7.2">
        <h3 id="name-room-state-changes">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-room-state-changes" class="section-name selfRef">Room State Changes</a>
        </h3>
<p id="section-7.2-1">The state of the room can be changed by adding or removing users.  These changes
are described without a specific syntax as a list of adds and removes:<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<span id="name-changing-the-state-of-the-r"></span><div id="fig-room-state-change">
<figure id="figure-8">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-7.2-2.1">
<pre>
Add: ["diana@d.example", "eric@e.example"],
Remove: ["bob@b.example"],
</pre>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-changing-the-state-of-the-r" class="selfRef">Changing the state of the room</a>
          </figcaption></figure>
</div>
<p id="section-7.2-3">[[ NOTE: The syntax needs to be defined.  To go along with the more full
description of room state mentioned above, we need a more full taxonomy of the
ways that room state can change. ]]<a href="#section-7.2-3" class="pilcrow">¶</a></p>
<p id="section-7.2-4">To put these changes into effect, a client or server encodes them in an AppSync
proposal, signs the proposal as a PublicMessage, and submits them to the
<code>update</code> enpoint on the hub.<a href="#section-7.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="directory">
<section id="section-7.3">
        <h3 id="name-directory">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-directory" class="section-name selfRef">Directory</a>
        </h3>
<p id="section-7.3-1">Like the ACME protocol <span>[<a href="#RFC8555" class="cite xref">RFC8555</a>]</span>, the MIMI protocol uses a directory document
to convey the HTTPS URLs used to reach certain endpoints (as opposed to hard
coding the endpoints).<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<p id="section-7.3-2">The directory URL is discovered using the <code>mimi-protocol-directory</code> well-known
URI. The response is a JSON document with URIs for each type of endpoint.<a href="#section-7.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3-3">
<pre>
GET /.well-known/mimi-protocol-directory
</pre><a href="#section-7.3-3" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-7.3-4">
<pre>
{
  "keyMaterial":
     "https://mimi.example.com/v1/keyMaterial/{targetUser}",
  "update": "https://mimi.example.com/v1/update{roomId}",
  "notify": "https://mimi.example.com/v1/notify/{roomId}",
  "submitMessage":
     "https://mimi.example.com/v1/submitMessage/{roomId}",
  "groupInfo": "https://mimi.example.com/v1/groupInfo/{roomId}",
  "requestConsent":
     "https://mimi.example.com/v1/requestConsent/{targetUser}",
  "updateConsent":
     "https://mimi.example.com/v1/updateConsent/{requesterUser}"
}
</pre><a href="#section-7.3-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="fetch-key-material">
<section id="section-7.4">
        <h3 id="name-fetch-key-material">
<a href="#section-7.4" class="section-number selfRef">7.4. </a><a href="#name-fetch-key-material" class="section-name selfRef">Fetch Key Material</a>
        </h3>
<p id="section-7.4-1">This action attempts to claim initial keying material for all the clients
of a single user at a specific provider. The keying material may not be
reused unless identified as "last resort" keying material.<a href="#section-7.4-1" class="pilcrow">¶</a></p>
<p id="section-7.4-2">The target user's URI is listed in the request path. KeyPackages
requested using this primitive <span class="bcp14">MUST</span> be sent via the hub provider of whatever
room they will be used in. (If this is not the case, the hub provider will be
unable to forward a Welcome message to the target provider).<a href="#section-7.4-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.4-3">
<pre>
POST /keyMaterial/{targetUser}
</pre><a href="#section-7.4-3" class="pilcrow">¶</a>
</div>
<p id="section-7.4-4">The path includes the target user. The request body includes the protocol
(currently just MLS 1.0), and the requesting user. The request <span class="bcp14">SHOULD</span> include
the room ID for which the KeyPackage is intended, as the target may have only
granted consent for a specific room.<a href="#section-7.4-4" class="pilcrow">¶</a></p>
<p id="section-7.4-5">For MLS, the request includes a non-empty list of acceptable MLS ciphersuites,
and an MLS <code>RequiredCapabilities</code> object (which contains credential types,
non-default proposal types, and extensions) required by the requesting provider
(these lists can be an empty). The <code>lastResortAllowed</code> field <span class="bcp14">SHOULD</span> be false.<a href="#section-7.4-5" class="pilcrow">¶</a></p>
<p id="section-7.4-6">The request body has the following form.<a href="#section-7.4-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.4-7">
<pre>
enum {
    reserved(0),
    mls10(1),
    (255)
} Protocol;

struct {
    opaque uri&lt;V&gt;;
} IdentifierUri;

struct {
    Protocol protocol;
    IdentifierUri requestingUser;
    IdentifierUri targetUsers&lt;V&gt;;
    IdentifierUri roomId;
    select (protocol) {
        case mls10:
            CipherSuite acceptableCiphersuites&lt;V&gt;;
            RequiredCapabilities requiredCapabilities;
            bool lastResortAllowed;
    };
} KeyMaterialRequest;
</pre><a href="#section-7.4-7" class="pilcrow">¶</a>
</div>
<p id="section-7.4-8">The response contains a user status code that indicates keying material was
returned for all the user's clients (<code>success</code>), that keying material was
returned for some of their clients (<code>partialSuccess</code>), or a specific user code
indicating failure. If the user code is success or partialSuccess, each client
is enumerated in the response. Then for each client with a <em>client</em> success
code, the structure includes initial keying material (a KeyPackage for MLS 1.0).
If the client's code is <code>nothingCompatible</code>, the client's capabilities are
optionally included (The client's capabilities could be omitted for privacy
reasons.)<a href="#section-7.4-8" class="pilcrow">¶</a></p>
<p id="section-7.4-9">If the <em>user</em> code is <code>noCompatibleMaterial</code>, the provider <span class="bcp14">MAY</span> populate the
<code>clients</code> list. For any other user code, the provider <span class="bcp14">MUST NOT</span> populate the
<code>clients</code> list.<a href="#section-7.4-9" class="pilcrow">¶</a></p>
<p id="section-7.4-10">Keying material provided from one response <span class="bcp14">MUST NOT</span> be provided in any other
response unless the <code>lastResortAllowed</code> field was set in the requests.
The target provider <span class="bcp14">MUST NOT</span> provide expired keying material (ex: an MLS
KeyPackage containing a LeafNode with a <code>notAfter</code> time past the current date
and time).<a href="#section-7.4-10" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.4-11">
<pre>
enum {
    success(0);
    partialSuccess(1);
    incompatibleProtocol(2);
    noCompatibleMaterial(3);
    userUnknown(4);
    noConsent(5);
    noConsentForThisRoom(6);
    userDeleted(7);
    (255)
} KeyMaterialUserCode;

enum {
    success(0);
    keyMaterialExhausted(1);
    onlyLastResort(2);
    nothingCompatible(3);
    (255)
} KeyMaterialClientCode;


struct {
    KeyMaterialClientCode clientStatus;
    IdentifierUri clientUri;
    select (protocol) {
        case mls10:
            select (clientStatus) {
                case success:
                    KeyPackage keyPackage;
                case nothingCompatible:
                    optional&lt;Capabilities&gt; clientCapabilities;
            };
    };
} ClientKeyMaterial;

struct {
    Protocol protocol;
    KeyMaterialUserCode userStatus;
    IdentifierUri userUri;
    ClientKeyMaterial clients&lt;V&gt;;
} KeyMaterialResponse;
</pre><a href="#section-7.4-11" class="pilcrow">¶</a>
</div>
<p id="section-7.4-12">At minimum, as each MLS KeyPackage is returned to a requesting provider (on
behalf of a requesting IM client), the target provider needs to associate its
<code>KeyPackageRef</code> with the target client and the hub provider needs to associate
its <code>KeyPackageRef</code> with the target provider. This insures that Welcome messages
can be correctly routed to the target provider and client. These associations
can be deleted after a Welcome message is forwarded or after the KeyPackage
<code>leaf_node.lifetime.not_after</code> time has passed.<a href="#section-7.4-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="update-room-state">
<section id="section-7.5">
        <h3 id="name-update-room-state">
<a href="#section-7.5" class="section-number selfRef">7.5. </a><a href="#name-update-room-state" class="section-name selfRef">Update Room State</a>
        </h3>
<p id="section-7.5-1">Adds, removes, and policy changes to the room are all forms of updating the room
state. They are accomplished using the update transaction which is used for
updating the room base policy, participation list, or its underlying MLS group.<a href="#section-7.5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.5-2">
<pre>
POST /update/{roomId}
</pre><a href="#section-7.5-2" class="pilcrow">¶</a>
</div>
<p id="section-7.5-3">In MLS 1.0, any change to the room base policy document is always expressed
using a <code>GroupContextExtensions</code> proposal. Likewise, any change to the
participant list is always communicated via an <code>AppSync</code> proposal type. The
participant list change needed to add a user <span class="bcp14">MUST</span> happen either before or
simultaneously with the corresponding MLS operation.<a href="#section-7.5-3" class="pilcrow">¶</a></p>
<p id="section-7.5-4">Removing an active user from a participant list or banning an active participant
<span class="bcp14">SHOULD</span> happen simultaneously with any MLS changes made to the commit removing
the participant.<a href="#section-7.5-4" class="pilcrow">¶</a></p>
<p id="section-7.5-5">A hub provider which observes that an active user has been removed or banned,
but still has clients <span class="bcp14">MUST</span> prevent any of those clients from sending or
receiving any additional application messages; <span class="bcp14">MUST</span> prevent any of those clients
from sending Commit messages; and <span class="bcp14">MUST</span> prevent it from sending any proposals
except for <code>Remove</code> and <code>SelfRemove</code> proposals.<a href="#section-7.5-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.5-6">
<pre>
enum {
  reserved(0),
  system(1),
  owner(2),
  admin(3),
  regular_user(4),
  visitor(5),
  banned(6),
  (255)
} Role;

struct {
  IdentifierUri user;
  Role roles&lt;V&gt;;
} UserRoles;

struct {
    UserRoles participants&lt;V&gt;;
} MimiParticipantList;
</pre><a href="#section-7.5-6" class="pilcrow">¶</a>
</div>
<p id="section-7.5-7">Each user can be added with one or more roles. This list of roles can be
updated. Note that removing a user does not ban the user. To ban a user,
update their role to <code>banned</code>.<a href="#section-7.5-7" class="pilcrow">¶</a></p>
<p id="section-7.5-8">The update request body is described below:<a href="#section-7.5-8" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.5-9">
<pre>
struct {
  select (room.protocol) {
    case mls10:
      PublicMessage proposalOrCommit;
      select (proposalOrCommit.content.content_type) {
        case commit:
          optional&lt;Welcome&gt; welcome;
          GroupInfo groupInfo;   /* without embedded ratchet_tree */
          RatchetTreeOption ratchetTreeOption;
        case proposal:
          PublicMessage moreProposals&lt;V&gt;; /* a list of additional proposals */
      };
  };
};
</pre><a href="#section-7.5-9" class="pilcrow">¶</a>
</div>
<p id="section-7.5-10">In the first use case described in the Protocol Overview, Alice creates a Commit
containing an AppSync proposal adding <code>bob@b.example</code>, and Add proposals for all
Bob's MLS clients.  Alice includes the Welcome message which will be sent for
Bob, a GroupInfo object for the hub provider, and complete <code>ratchet_tree</code>
extension.<a href="#section-7.5-10" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.5-11">
<pre>
enum {
  reserved(0),
  full(1),
  compressed(2),
  delta(3),
  patch(4),
  byReference(5)
  (255)
} RatchetTreeRepresentation;

struct {
  RatchetTreeRepresentation representation;
  select (representation) {
    case full:
      Node ratchet_tree&lt;V&gt;;
  };
} RatchetTreeOption;
</pre><a href="#section-7.5-11" class="pilcrow">¶</a>
</div>
<p id="section-7.5-12">The response body is described below:<a href="#section-7.5-12" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-7.5-13">
<pre>
enum {
  success(0),
  wrongEpoch(1),
  notAllowed(2),
  hubUnresponsive(3),
  invalidProposal(4),
  (255)
} UpdateResponseCode;

struct {
    UpdateResponseCode responseCode;
    string errorDescription;
} UpdateRoomResponse
</pre><a href="#section-7.5-13" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="submit-a-message">
<section id="section-7.6">
        <h3 id="name-submit-a-message">
<a href="#section-7.6" class="section-number selfRef">7.6. </a><a href="#name-submit-a-message" class="section-name selfRef">Submit a Message</a>
        </h3>
<div class="alignLeft art-text artwork" id="section-7.6-1">
<pre>
POST /submitMessage/{roomId}
</pre><a href="#section-7.6-1" class="pilcrow">¶</a>
</div>
<p id="section-7.6-2">If the protocol is MLS 1.0, the request body is an MLSMessage with. a WireFormat
of PrivateMessage (an application message).<a href="#section-7.6-2" class="pilcrow">¶</a></p>
<p id="section-7.6-3">The response merely indicates if the message was accepted by the hub provider.<a href="#section-7.6-3" class="pilcrow">¶</a></p>
<p id="section-7.6-4"><strong>ISSUE:</strong> Do we want to offer a distinction between regular application
messages and ephemeral applications messages (for example "is typing"
notifications), which do not need to be queued at the target provider.<a href="#section-7.6-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="fanout-messages-and-room-events">
<section id="section-7.7">
        <h3 id="name-fanout-messages-and-room-ev">
<a href="#section-7.7" class="section-number selfRef">7.7. </a><a href="#name-fanout-messages-and-room-ev" class="section-name selfRef">Fanout Messages and Room Events</a>
        </h3>
<p id="section-7.7-1">If the hub provider accepts an application or handshake message (proposal or
commit) message, it forwards that message to all other providers with active
participants in the room and all local clients which are active participants.
This is described as fanning the message out. An MLS Welcome message is sent to
the providers and local users associated with the <code>KeyPackageRef</code> values in
the <code>secrets</code> array of the Welcome. In the case of a Welcome message, a
<code>RatchetTreeOption</code> is also included in the FanoutMessage.<a href="#section-7.7-1" class="pilcrow">¶</a></p>
<p id="section-7.7-2">The hub provider also fans out any messages which originate from itself (ex: MLS
External Proposals).<a href="#section-7.7-2" class="pilcrow">¶</a></p>
<p id="section-7.7-3">The hub can include multiple concatenated <code>FanoutMessage</code> objects relevant to
the same room.<a href="#section-7.7-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.7-4">
<pre>
POST /notify/{roomId}
</pre><a href="#section-7.7-4" class="pilcrow">¶</a>
</div>
<div class="lang-tls sourcecode" id="section-7.7-5">
<pre>
struct {
  uint64 timestamp;
  MLSMessage message;
  /* the hub acceptance time (in milliseconds from the UNIX epoch) */
  select (message.wire_format) {
    case welcome:
      RatchetTreeOption ratchetTreeOption;
  };
} FanoutMessage;
</pre><a href="#section-7.7-5" class="pilcrow">¶</a>
</div>
<p id="section-7.7-6"><strong>NOTE:</strong> Correctly fanning out Welcome messages relies on the hub and target
providers storing the <code>KeyPackageRef</code> of claimed KeyPackages.<a href="#section-7.7-6" class="pilcrow">¶</a></p>
<p id="section-7.7-7">To be clear, clients that are being removed <span class="bcp14">SHOULD</span> receive the corresponding
Commit message, so they can recognize that they have been removed and clean up
their internal state.<a href="#section-7.7-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="use-of-mls-dsas">
<section id="section-8">
      <h2 id="name-use-of-mls-ds-as">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-use-of-mls-ds-as" class="section-name selfRef">Use of MLS DS/AS</a>
      </h2>
<p id="section-8-1">MLS defines an abstract Delivery Server (DS) and Authentication Server (AS).
This abstract functionality is split across all the MLS clients and the
providers, but an important function is provided specifically by the hub
provider. The hub is responsible for the ordering of messages, fanning messages
out to the appropriate providers, and maintaining the GroupInfo so authorized
clients can add themselves to groups using an external commit.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">The MLS profile for MIMI requires a concept of a user identifier and a mechanism
to associate credentials in MLS clients to MIMI users.<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">Clients are free to fetch pseudonymous user identifiers from their local
provider, and use these in rooms. These pseudonymns need only identify the
client's provider to other providers and clients. The actual user identity could
be shared among the active participants of the room, by using a credential with
selective disclosures, or by signing a binding with both the pseudonymous
signature key and the "real" identity signature key and presenting the binding
to other members.<a href="#section-8-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mls-application-state-synchronization">
<section id="section-9">
      <h2 id="name-mls-application-state-synch">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-mls-application-state-synch" class="section-name selfRef">MLS Application State Synchronization</a>
      </h2>
<p id="section-9-1">[[ This section should be moved to its own document in the MLS working group ]]<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">One of the primary security benefits of MLS is that the MLS key schedule
confirms that the group agrees on certain metadata, such as the membership of
the group. Members that disagree on the relevant metadata will arrive at
different keys and be unable to communicate. Applications based on MLS can
integrate their state into this metadata in order to confirm that the member of
an MLS group agree on application state as well as MLS metadata.<a href="#section-9-2" class="pilcrow">¶</a></p>
<p id="section-9-3">Here, we define two extensions to MLS to facilitate this application design:<a href="#section-9-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9-4">
<li id="section-9-4.1">
          <p id="section-9-4.1.1">A GroupContext extension <code>application_states</code> that confirms agreement on
application state from potentially multiple sources.<a href="#section-9-4.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-9-4.2">
          <p id="section-9-4.2.1">A new proposal type AppSync that allows MLS group members to propose changes
to the agreed application state.<a href="#section-9-4.2.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-9-5">The <code>application_states</code> extension allows the application to inject state
objects into the MLS key schedule. Changes to this state can be made out of
band, or using the AppSync proposal. Using the AppSync proposal ensures that
members of the MLS group have received the relevant state changes before they
are reflected in the group's <code>application_states</code>.<a href="#section-9-5" class="pilcrow">¶</a></p>
<p id="section-9-6">[[ NOTE: This design exposes the high-level structure of the application state
to MLS.  An alternative design would be to have the application state be opaque
to MLS.  There is a trade-off between generality and the complexity of the API
between the MLS implementation and the application.  An opaque design would give
the application more freedom, but require the MLS stack to call out to the
application to get the updated state as part of Commit processing.  This design
allows the updates to happen within the MLS stack, so that no callback is
needed, at the cost of forcing the application state to fit a certain structure.
]]<a href="#section-9-6" class="pilcrow">¶</a></p>
<p id="section-9-7">The state for Each <code>applicationId</code> in the <code>application_states</code> needs to conform
to one of four basic types: an ordered array, an unordered array, a map, or an
irreducible blob. This allows the AppSync proposal to efficiently modify a large
application state object.<a href="#section-9-7" class="pilcrow">¶</a></p>
<p id="section-9-8">The content of the <code>application_states</code> extension and the <code>AppSync</code> proposal are
structured as follows:<a href="#section-9-8" class="pilcrow">¶</a></p>
<span id="name-the-application_state-exten"></span><div id="fig-app-state">
<figure id="figure-9">
        <div class="lang-tls sourcecode" id="section-9-9.1">
<pre>
struct {
  opaque element&lt;V&gt;;
} OpaqueElement;

struct {
  opaque elementName&lt;V&gt;;
  opaque elementValue&lt;V&gt;;
} OpaqueMapElement;

struct {
  uint32 applicationId;
  StateType stateType;
  select (stateType) {
    case irreducible:
      OpaqueElement state;
    case map:
      OpaqueMapElement mapEntries&lt;V&gt;;
    case unorderedList:
      OpaqueElement unorderedEntries&lt;V&gt;;
    case orderedArray:
      OpaqueElement orderedEntries&lt;V&gt;;
  };
} ApplicationState;

struct {
  ApplicationState applicationStates&lt;V&gt;;
} ApplicationStatesExtension;
</pre>
</div>
<figcaption><a href="#figure-9" class="selfRef">Figure 9</a>:
<a href="#name-the-application_state-exten" class="selfRef">The application_state extension</a>
        </figcaption></figure>
</div>
<span id="name-the-appsync-proposal-type"></span><div id="fig-app-sync">
<figure id="figure-10">
        <div class="lang-tls sourcecode" id="section-9-10.1">
<pre>
struct {
  uint32 index;
  opaque element&lt;V&gt;;
} ElementWithIndex;


struct {
  uint32 applicationId;
  StateType stateType;
  select (stateType) {
    case irreducible:
      OpaqueElement newState;
    case map:
      OpaqueElement removedKeys&lt;V&gt;;
      OpaqueMapElement newOrUpdatedElements&lt;V&gt;;
    case unorderedList:
      uint32 removedIndices&lt;V&gt;;
      OpaqueElement addedEntries&lt;V&gt;;
    case orderedArray:
      ElementWithIndex replacedElements&lt;V&gt;;
      uint32 removedIndices&lt;V&gt;;
      ElementWithIndex insertedElements&lt;V&gt;;
      OpaqueElement appenededEntries&lt;V&gt;;
  };
} AppSync;
</pre>
</div>
<figcaption><a href="#figure-10" class="selfRef">Figure 10</a>:
<a href="#name-the-appsync-proposal-type" class="selfRef">The AppSync proposal type</a>
        </figcaption></figure>
</div>
<p id="section-9-11">The <code>applicationId</code> determines the structure and interpretation of the contents.
of an ApplicationState object. AppSync proposals
contain changes to this state, which the client uses to update the
representation of the state in <code>application_states</code>.<a href="#section-9-11" class="pilcrow">¶</a></p>
<p id="section-9-12">A client receiving an AppSync proposal applies it in the following way:<a href="#section-9-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-13.1">
          <p id="section-9-13.1.1">Identify an <code>application_states</code> GroupContext extension which contains the
same <code>application_id</code> state as the AppSync proposal<a href="#section-9-13.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-9-13.2">
          <p id="section-9-13.2.1">Apply the relevant operations (replace, remove, update, append, insert)
according to the <code>stateType</code> to the relevant parts of the ApplicationState
object in <code>application_states</code> extension.<a href="#section-9-13.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-9-14">An AppSync for an irreducible state replaces its <code>state</code> element with a new
(possibly empty) <code>newState</code>. An AppSync for a map-based ApplicationState first
removes all the keys in <code>removedKeys</code> and than replaces or adds the elements in
<code>newOrUpdatedElements</code>. An AppSync for an unorderedList ApplicationState first
removes all the indexes in <code>removedIndices</code>, then adds the elements in
<code>addedEntries</code>. Finally an AppSync for an orderedArray, replaces all the
elements (index-by-index) in <code>replacedElements</code>, the removes the elements in
<code>removedIndices</code> according to the then order of the array, then inserts all the
elements in <code>insertedElements</code> according to the then order of the array, then
finally appends the <code>appendedEntries</code> (in order). All indices are zero-based.<a href="#section-9-14" class="pilcrow">¶</a></p>
<p id="section-9-15">Note that the <code>application_states</code> extension is updated directly by AppSync
proposals; a GroupContextExtensions proposal is not necessary. A proposal list
that contains both an AppSync proposal and a GroupContextExtensions proposal
is invalid.<a href="#section-9-15" class="pilcrow">¶</a></p>
<p id="section-9-16">Likewise a proposal list in a Commit <span class="bcp14">MAY</span> contain more than one AppSync proposal,
but no more than one AppSync proposal per <code>applicationId</code>. The proposals are
applied in the order that they are sent in the Commit.<a href="#section-9-16" class="pilcrow">¶</a></p>
<p id="section-9-17">AppSync proposals do not need to contain an UpdatePath. An AppSync proposal can be sent by an authorized external sender.<a href="#section-9-17" class="pilcrow">¶</a></p>
<p id="section-9-18">[[ TODO: IANA registry for application_id; register extension and proposal types
as safe extensions ]]<a href="#section-9-18" class="pilcrow">¶</a></p>
</section>
</div>
<div id="consent">
<section id="section-10">
      <h2 id="name-consent">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-consent" class="section-name selfRef">Consent</a>
      </h2>
<p id="section-10-1">Most instant messaging systems have some notion of how a user consents to be
added to a room, and how they manipulate this consent.<a href="#section-10-1" class="pilcrow">¶</a></p>
<p id="section-10-2">In the connection-oriented model, once two users are connected, either user can
add the other to any number of rooms. In other systems (often with many large
and/or public rooms), a user needs to consent individually to be added to a
room.<a href="#section-10-2" class="pilcrow">¶</a></p>
<p id="section-10-3">The MIMI consent mechanism supports both models and allows them to coexist. It
allows a user to request consent, grant consent, revoke consent, and cancel a
request for consent. Each of these consent operations can indicate a specific
room, or indicate any room.<a href="#section-10-3" class="pilcrow">¶</a></p>
<p id="section-10-4">A connection grant or revoke does not need to specify a room if a connection
request did, or vice versa. A connection grant or revoke does not even need to
follow a connection request.<a href="#section-10-4" class="pilcrow">¶</a></p>
<p id="section-10-5">For example, Alice could ask for consent to add Bob to a specific room. Bob
could send a connection grant for Alice to add him to any room, or a connection
revoke preventing Alice from adding him to any room. Similarly, Alice might have
sent a connection request to add Bob for any room (as a connection request),
which Bob ignored or did not see. Later, Bob wants to join a specific room
administered by Alice. Bob sends a connection grant for the specific room for
Alice and sends a Knock request to Alice asking to be added. Finally, Cathy
could send a connection grant for Bob (even if Bob did not initiate a connection
request to Cathy), and Alice could recognize Cathy on the system and send a
connection revoke for her preemptively.<a href="#section-10-5" class="pilcrow">¶</a></p>
<p id="section-10-6"><strong>NOTE:</strong> Many providers use additional factors to apply default consent within
their service such as a user belonging to a specific workgroup or employer,
participating in a related room (ex: WhatsApp "communities"), or presence of a
user in the other user's contact list. MIMI does not need to provide a way to
replicate or describe these supplemental mechanisms, since they are strongly
linked to specific provider policies.<a href="#section-10-6" class="pilcrow">¶</a></p>
<p id="section-10-7">Consent requests have sensitive privacy implications. The sender of a consent
request should receive an acknowledgement that the request was received by the
<em>provider</em> of the target user. For privacy reasons, the requestor should not
know if the target user received or viewed the request. The original requestor
will obviously find out if the target grants consent, but a consent
revocation/rejection is typically not communicated to the revoked/rejected user
(again for privacy reasons).<a href="#section-10-7" class="pilcrow">¶</a></p>
<p id="section-10-8">Consent operations are only sent directly between the acting provider (sending
the request, grant, revoke, or cancel) and the target provider (the object of
the consent). In other words, the two providers must have a direct peering
relationship.<a href="#section-10-8" class="pilcrow">¶</a></p>
<p id="section-10-9">In our example, Alice requests consent from Bob for any room. Later, Bob sends a
grants consent to Alice to add him to any room. At the same time as sending the
consent request, Alice grants consent to Bob to add her to any room.<a href="#section-10-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-11">
      <h2 id="name-security-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-11-1">The MIMI protocol incorporates several layers of security.<a href="#section-11-1" class="pilcrow">¶</a></p>
<p id="section-11-2">Individual protocol actions are protected against network attackers with
mutually-authenticated TLS, where the TLS certificates authenticate the
identities that the protocol actors assert at the application layer.<a href="#section-11-2" class="pilcrow">¶</a></p>
<p id="section-11-3">Messages and room state changes are protected end-to-end using MLS.  The
protection is "end-to-end" in the sense that messages sent within the group are
confidentiality-protected against all servers involved in the delivery of those
messages, and in the sense that the authenticity of room state changes is
verified by the end clients involved in the room.  The usage of MLS ensures that
the servers facilitating the exchange cannot read messages in the room or
falsify room state changes, even though they can read the room state change
messages.<a href="#section-11-3" class="pilcrow">¶</a></p>
<p id="section-11-4">Each room has an authorization policy that dictates which protocol actors can
perform which actions in the room.  This policy is enforced by the hub server
for the room.  The actors for whom the policy is being evaluated authenticate
their identities to the hub server using the MLS PublicMessage signed object
format, together with the identity credentials presented in MLS.<a href="#section-11-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-12">
      <h2 id="name-iana-considerations">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-12-1">This document has no IANA actions.<a href="#section-12-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-13">
      <h2 id="name-references">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-13.1">
        <h3 id="name-normative-references">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-02</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mimi-arch">[I-D.mimi-arch]</dt>
        <dd>
<span class="refTitle">"*** BROKEN REFERENCE ***"</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6125">[RFC6125]</dt>
        <dd>
<span class="refAuthor">Saint-Andre, P.</span> and <span class="refAuthor">J. Hodges</span>, <span class="refTitle">"Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 6125</span>, <span class="seriesInfo">DOI 10.17487/RFC6125</span>, <time datetime="2011-03" class="refDate">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6125">https://www.rfc-editor.org/rfc/rfc6125</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7231">[RFC7231]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span> and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content"</span>, <span class="seriesInfo">RFC 7231</span>, <span class="seriesInfo">DOI 10.17487/RFC7231</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7231">https://www.rfc-editor.org/rfc/rfc7231</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9420">[RFC9420]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="seriesInfo">RFC 9420</span>, <span class="seriesInfo">DOI 10.17487/RFC9420</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9420">https://www.rfc-editor.org/rfc/rfc9420</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-13.2">
        <h3 id="name-informative-references">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.mahy-mimi-identity">[I-D.mahy-mimi-identity]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) Identity Concepts"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mimi-identity-02</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02">https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8555">[RFC8555]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Hoffman-Andrews, J.</span>, <span class="refAuthor">McCarney, D.</span>, and <span class="refAuthor">J. Kasten</span>, <span class="refTitle">"Automatic Certificate Management Environment (ACME)"</span>, <span class="seriesInfo">RFC 8555</span>, <span class="seriesInfo">DOI 10.17487/RFC8555</span>, <time datetime="2019-03" class="refDate">March 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8555">https://www.rfc-editor.org/rfc/rfc8555</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">TODO acknowledge.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Richard L. Barnes</span></div>
<div dir="auto" class="left"><span class="org">Cisco</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rlb@ipv.sx" class="email">rlb@ipv.sx</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Matthew Hodgson</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:matthew@matrix.org" class="email">matthew@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Rohan Mahy</span></div>
<div dir="auto" class="left"><span class="org">Wire</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rohan.mahy@wire.com" class="email">rohan.mahy@wire.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
