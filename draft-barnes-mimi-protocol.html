<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>More Instant Messaging Interoperability: The Protocol</title>
<meta content="Richard L. Barnes" name="author">
<meta content="Matthew Hodgson" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="Rohan Mahy" name="author">
<meta content="Travis Ralston" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider. 
    " name="description">
<meta content="xml2rfc 3.19.0" name="generator">
<meta content="next generation" name="keyword">
<meta content="unicorn" name="keyword">
<meta content="sparkling distributed ledger" name="keyword">
<meta content="draft-barnes-mimi-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.19.0
    Python 3.11.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 4.1.0
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.2.2
    six 1.16.0
    wcwidth 0.2.12
-->
<link href="draft-barnes-mimi-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI Protocol</td>
<td class="right">January 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Barnes, et al.</td>
<td class="center">Expires 14 July 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-barnes-mimi-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2024-01-11" class="published">11 January 2024</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-07-14">14 July 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. L. Barnes</div>
<div class="org">Cisco</div>
</div>
<div class="author">
      <div class="author-name">M. Hodgson</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Mahy</div>
<div class="org">Wire</div>
</div>
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">More Instant Messaging Interoperability: The Protocol</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://bifurcation.github.io/mimi-protocol/draft-barnes-mimi-protocol.html">https://bifurcation.github.io/mimi-protocol/draft-barnes-mimi-protocol.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-barnes-mimi-protocol/">https://datatracker.ietf.org/doc/draft-barnes-mimi-protocol/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/bifurcation/mimi-protocol">https://github.com/bifurcation/mimi-protocol</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 14 July 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-protocol-overview" class="internal xref">Protocol Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-alice-creates-a-room" class="internal xref">Alice Creates a Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-alice-adds-bob-to-the-room" class="internal xref">Alice adds Bob to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-bob-adds-cathy-to-the-room" class="internal xref">Bob adds Cathy to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-cathy-sends-a-message" class="internal xref">Cathy Sends a Message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-bob-leaves-the-room" class="internal xref">Bob Leaves the Room</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-transport-layer" class="internal xref">Transport layer</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-e2e-security-layer" class="internal xref">E2E Security Layer</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-application-layer" class="internal xref">Application Layer</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-room-state" class="internal xref">Room State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-application-endpoints" class="internal xref">Application Endpoints</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.1">
                    <p id="section-toc.1-1.6.2.2.2.1.1"><a href="#section-6.2.1" class="auto internal xref">6.2.1</a>.  <a href="#name-fetching-key-material-for-a" class="internal xref">Fetching Key Material for a User</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-mls-applicationsync-proposa" class="internal xref">MLS ApplicationSync Proposal</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-consent-sketch" class="internal xref">Consent Sketch</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-hedgedoc-content-below-this" class="internal xref">HEDGEDOC CONTENT BELOW THIS LINE</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-operational-model" class="internal xref">Operational Model</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-abcs-of-the-protocol" class="internal xref">ABCs of the Protocol</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="auto internal xref">11.1</a>.  <a href="#name-dramatis-personae" class="internal xref">Dramatis Personae</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="auto internal xref">11.2</a>.  <a href="#name-alice-creates-a-room-2" class="internal xref">Alice creates a room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3">
                <p id="section-toc.1-1.11.2.3.1"><a href="#section-11.3" class="auto internal xref">11.3</a>.  <a href="#name-alice-adds-bob" class="internal xref">Alice adds Bob</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3.2.1">
                    <p id="section-toc.1-1.11.2.3.2.1.1"><a href="#section-11.3.1" class="auto internal xref">11.3.1</a>.  <a href="#name-alice-gets-initial-keying-m" class="internal xref">Alice gets initial keying material for Bob</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3.2.2">
                    <p id="section-toc.1-1.11.2.3.2.2.1"><a href="#section-11.3.2" class="auto internal xref">11.3.2</a>.  <a href="#name-alice-adds-bob-to-the-parti" class="internal xref">Alice adds Bob to the participant list and MLS group</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3.2.3">
                    <p id="section-toc.1-1.11.2.3.2.3.1"><a href="#section-11.3.3" class="auto internal xref">11.3.3</a>.  <a href="#name-alice-and-bob-exchange-mess" class="internal xref">Alice and Bob exchange messages</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.4">
                <p id="section-toc.1-1.11.2.4.1"><a href="#section-11.4" class="auto internal xref">11.4</a>.  <a href="#name-alice-makes-bob-a-room-admi" class="internal xref">Alice makes Bob a room administrator</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.5">
                <p id="section-toc.1-1.11.2.5.1"><a href="#section-11.5" class="auto internal xref">11.5</a>.  <a href="#name-bob-leaves-the-room-3" class="internal xref">Bob leaves the room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.6">
                <p id="section-toc.1-1.11.2.6.1"><a href="#section-11.6" class="auto internal xref">11.6</a>.  <a href="#name-cathy-removes-doug" class="internal xref">Cathy removes Doug</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.7">
                <p id="section-toc.1-1.11.2.7.1"><a href="#section-11.7" class="auto internal xref">11.7</a>.  <a href="#name-cathy-gets-a-new-client" class="internal xref">Cathy gets a new client</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.8">
                <p id="section-toc.1-1.11.2.8.1"><a href="#section-11.8" class="auto internal xref">11.8</a>.  <a href="#name-consent" class="internal xref">Consent</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.9">
                <p id="section-toc.1-1.11.2.9.1"><a href="#section-11.9" class="auto internal xref">11.9</a>.  <a href="#name-other-ways-to-join" class="internal xref">Other ways to join</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.9.2.1">
                    <p id="section-toc.1-1.11.2.9.2.1.1"><a href="#section-11.9.1" class="auto internal xref">11.9.1</a>.  <a href="#name-joining-with-an-join-url-co" class="internal xref">Joining with an join URL / code</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.9.2.2">
                    <p id="section-toc.1-1.11.2.9.2.2.1"><a href="#section-11.9.2" class="auto internal xref">11.9.2</a>.  <a href="#name-joining-an-open-room" class="internal xref">Joining an open room</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.9.2.3">
                    <p id="section-toc.1-1.11.2.9.2.3.1"><a href="#section-11.9.3" class="auto internal xref">11.9.3</a>.  <a href="#name-knocks" class="internal xref">Knocks</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.9.2.4">
                    <p id="section-toc.1-1.11.2.9.2.4.1"><a href="#section-11.9.4" class="auto internal xref">11.9.4</a>.  <a href="#name-invites" class="internal xref">Invites</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.10">
                <p id="section-toc.1-1.11.2.10.1"><a href="#section-11.10" class="auto internal xref">11.10</a>. <a href="#name-reporting-abuse-spam" class="internal xref">Reporting abuse/spam</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.11">
                <p id="section-toc.1-1.11.2.11.1"><a href="#section-11.11" class="auto internal xref">11.11</a>. <a href="#name-alice-sends-an-attachment-w" class="internal xref">Alice sends an attachment which Cathy downloads</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.12">
                <p id="section-toc.1-1.11.2.12.1"><a href="#section-11.12" class="auto internal xref">11.12</a>. <a href="#name-getting-the-internal-identi" class="internal xref">Getting the internal identitifier for a user</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.13">
                <p id="section-toc.1-1.11.2.13.1"><a href="#section-11.13" class="auto internal xref">11.13</a>. <a href="#name-moderation" class="internal xref">Moderation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-definition-of-primitives" class="internal xref">Definition of Primitives</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="auto internal xref">12.1</a>.  <a href="#name-mimi-url-directory" class="internal xref">MIMI URL directory</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="auto internal xref">12.2</a>.  <a href="#name-obtain-consent" class="internal xref">Obtain consent</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3">
                <p id="section-toc.1-1.12.2.3.1"><a href="#section-12.3" class="auto internal xref">12.3</a>.  <a href="#name-claim-keys" class="internal xref">Claim keys</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.4">
                <p id="section-toc.1-1.12.2.4.1"><a href="#section-12.4" class="auto internal xref">12.4</a>.  <a href="#name-change-room-policy-particip" class="internal xref">Change room policy/participation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.5">
                <p id="section-toc.1-1.12.2.5.1"><a href="#section-12.5" class="auto internal xref">12.5</a>.  <a href="#name-send-provisional-message" class="internal xref">Send provisional message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6">
                <p id="section-toc.1-1.12.2.6.1"><a href="#section-12.6" class="auto internal xref">12.6</a>.  <a href="#name-fan-out-messages" class="internal xref">Fan out messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7">
                <p id="section-toc.1-1.12.2.7.1"><a href="#section-12.7" class="auto internal xref">12.7</a>.  <a href="#name-claim-end-to-end-crypto-gro" class="internal xref">Claim end-to-end crypto group key information</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.8">
                <p id="section-toc.1-1.12.2.8.1"><a href="#section-12.8" class="auto internal xref">12.8</a>.  <a href="#name-download-files" class="internal xref">Download files</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.9">
                <p id="section-toc.1-1.12.2.9.1"><a href="#section-12.9" class="auto internal xref">12.9</a>.  <a href="#name-report-abuse" class="internal xref">Report abuse</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.10">
                <p id="section-toc.1-1.12.2.10.1"><a href="#section-12.10" class="auto internal xref">12.10</a>. <a href="#name-find-internal-address" class="internal xref">Find internal address</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-use-of-mls-ds-as" class="internal xref">Use of MLS DS/AS</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="auto internal xref">14</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="auto internal xref">15</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16" class="auto internal xref">16</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#section-16.1" class="auto internal xref">16.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2">
                <p id="section-toc.1-1.16.2.2.1"><a href="#section-16.2" class="auto internal xref">16.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18">
            <p id="section-toc.1-1.18.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The goal of the More Instant Messaging Interoperability (MIMI) Working Group is
to enable multiple providers of end-to-end encrypted instant messaging to
interoperate. As described in the MIMI architecture, group chats and direct
messages are described in terms of "rooms". Each MIMI protocol room is hosted at
a single provider (the "hub" provider"), but allows users from different
providers to become participants in the room. The hub provider maintains the
policy and participation for the room, authorizes messages, and is responsible
for message ordering, the participation list, and policy of its rooms. Each
provider also stores initial keying material and consent for its users (who may
be offline).<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes the communication between and among different providers
necessary to send and receive encrypted messages, share room policy, and add
participants to and remove participants from rooms. In support of these
functions, the protocol also has primitives to fetch initial keying material,
fetch the current MLS GroupInfo, and request, grant, and reject consent to
communicate with users on other providers.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">Messages sent inside each room are end-to-end encrypted using the Messaging
Layer Security (MLS) protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, and each room is associated with an
MLS group. MLS also ensures that clients in a room agree on the room policy and
participation. One of the core principles of this protocol is that ar all times,
the clients of the end-to-end encryption protocol (the MLS clients who are in an
MLS group) all need to correspond to users who are in the associated room.<a href="#section-1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Most MIMI-related terms are inherited from <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>. Readers
of this document should be familiar with the Terminology section of the MLS protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">Throughout this document, the examples use the TLS Presentation Language
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> and the semantics of HTTP <span>[<a href="#RFC7231" class="cite xref">RFC7231</a>]</span> respectively as
placeholders for a binary encoding mechanism and transport semantics.<a href="#section-2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="protocol-overview">
<section id="section-3">
      <h2 id="name-protocol-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
      </h2>
<p id="section-3-1">As shown in <a href="#fig-layers" class="auto internal xref">Figure 1</a>, the overall MIMI protocol is built out of three layers:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3-2">
<li id="section-3-2.1">
          <p id="section-3-2.1.1">An application layer that enables messaging functionality<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-3-2.2">
          <p id="section-3-2.2.1">A security layer that provides end-to-end security guarantees:<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.2.2.1">
              <p id="section-3-2.2.2.1.1">Confidentiality for messages<a href="#section-3-2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3-2.2.2.2">
              <p id="section-3-2.2.2.2.1">Authentication of actors making changes to rooms<a href="#section-3-2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3-2.2.2.3">
              <p id="section-3-2.2.2.3.1">Agreement on room state across the clients involved in a room<a href="#section-3-2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li id="section-3-2.3">
          <p id="section-3-2.3.1">A transport layer that provides secure delivery of protocol objects between
servers.<a href="#section-3-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-3-3">The MIMI transport is based on HTTPS over mutually-authenticated TLS.  MIMI uses
MLS <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span> for end-to-end security, using the MLS ApplicationSecuritySync
proposal type to syncronize room state across the clients involved in a room.<a href="#section-3-3" class="pilcrow">¶</a></p>
<span id="name-mimi-protocol-layering"></span><div id="fig-layers">
<figure id="figure-1">
        <div id="section-3-4.1">
          <div class="alignLeft art-svg artwork" id="section-3-4.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="216" viewBox="0 0 216 144" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,32 L 8,128" fill="none" stroke="black"></path>
              <path d="M 72,64 L 72,96" fill="none" stroke="black"></path>
              <path d="M 208,32 L 208,128" fill="none" stroke="black"></path>
              <path d="M 8,32 L 208,32" fill="none" stroke="black"></path>
              <path d="M 72,64 L 208,64" fill="none" stroke="black"></path>
              <path d="M 8,96 L 208,96" fill="none" stroke="black"></path>
              <path d="M 8,128 L 208,128" fill="none" stroke="black"></path>
              <g class="text">
                <text x="112" y="52">Application</text>
                <text x="104" y="84">E2E</text>
                <text x="156" y="84">Security</text>
                <text x="112" y="116">Transport</text>
              </g>
            </svg><a href="#section-3-4.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-mimi-protocol-layering" class="selfRef">MIMI protocol layering</a>
        </figcaption></figure>
</div>
<p id="section-3-5">The remainder of this section walks through a basic scenario that illustrates
how a room works in the MIMI protocol.  The scenario involves the following
actors:<a href="#section-3-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-6.1">
          <p id="section-3-6.1.1">Service providers <code>alpha.com</code>, <code>bravo.com</code>, and <code>charlie.com</code> represented by
servers <code>ServerA</code>, <code>ServerB</code>, and <code>ServerC</code> respectively<a href="#section-3-6.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.2">
          <p id="section-3-6.2.1">Users Alice (<code>alice@alpha.com</code>), Bob (<code>bob@bravo.com</code>) and Cathy
(`cathy@charlie.com) of the respective service providers<a href="#section-3-6.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.3">
          <p id="section-3-6.3.1">Clients <code>ClientA1</code>, <code>ClientA2</code>, <code>ClientB1</code>, etc. belonging to these users<a href="#section-3-6.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-6.4">
          <p id="section-3-6.4.1">A room <code>clubhouse@alpha.com</code> where the three users interact<a href="#section-3-6.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-7">As noted in <span>[<a href="#I-D.mimi-arch" class="cite xref">I-D.mimi-arch</a>]</span>, the MIMI protocol only defines interactions
between service providers' servers.  Interactions between between clients and
servers within a service provider domain are shown here for completeness, but
surrounded by <code>[[ double brackets ]]</code>.<a href="#section-3-7" class="pilcrow">¶</a></p>
<div id="alice-creates-a-room">
<section id="section-3.1">
        <h3 id="name-alice-creates-a-room">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-alice-creates-a-room" class="section-name selfRef">Alice Creates a Room</a>
        </h3>
<p id="section-3.1-1">The first step in the lifetime of a MIMI room is its creation on the hub server.
This operation is local to the service provider, and does not entail any MIMI
protocol operations.  However, it must establish the initial state of the room,
which is then the basis for protocol operations related to the room.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">Here, we assume that Alice uses ClientA1 to create a room with the following
properties:<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-3.1">
            <p id="section-3.1-3.1.1">Identifier: <code>clubhouse@alpha.com</code><a href="#section-3.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-3.2">
            <p id="section-3.1-3.2.1">Participants: <code>[alice@alpha.com]</code><a href="#section-3.1-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-4">ClientA1 also creates an MLS group with group ID <code>clubhouse@alpha.com</code> and
ensures via provider-local operations that Alice's other clients are members of
this MLS group.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-bob-to-the-room">
<section id="section-3.2">
        <h3 id="name-alice-adds-bob-to-the-room">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-alice-adds-bob-to-the-room" class="section-name selfRef">Alice adds Bob to the Room</a>
        </h3>
<p id="section-3.2-1">Adding Bob to the room entails operations at two levels.  First, Bob's user
identity must be added to the room's participant list.  Second, Bob's clients
must be added to the room's MLS group.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The process of adding Bob to the room thus begins by Alice fetching key material
for Bob's clients.  Alice then updates the room by sending an MLS Commit over
the following proposals:<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2-3.1">
            <p id="section-3.2-3.1.1">An ApplicationSync proposal updating the room state by adding Bob to the
participant list<a href="#section-3.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.2-3.2">
            <p id="section-3.2-3.2.1">Add proposals for Bob's clients<a href="#section-3.2-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.2-4">The MIMI protocol interactions are between Alice's server ServerA and Bob's
server ServerB.  ServerB stores KeyPackages on behalf of Bob's devices.  ServerA
performs the key material fetch on Alice's behalf, and delivers the resulting
KeyPackages to Alice's clients.  Both ServerA and ServerB remember the sources
of the KeyPackages they handle, so that they can route a Welcome mesasage for
those KeyPackages to the proper recipients -- ServerA to ServerB, and ServerB to
Bob's clients.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
<p id="section-3.2-5">[[ NOTE: In the full protocol, it will be necessary to have consent and access
control on these operations.  We have elided that step here in the interest of
simplicity.  Some initial thoughts are in <a href="#consent" class="auto internal xref">Section 11.8</a> ]]<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<span id="name-alice-fetches-keypackages-f"></span><div id="fig-ab-kp-fetch">
<figure id="figure-2">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-3.2-6.1">
<pre>
ClientA1       ServerA         ServerB         ClientB*
  |               |               |               |
  |               |               |     Store KPs |
  |               |               |&lt;~~~~~~~~~~~~~~|
  |               |               |&lt;~~~~~~~~~~~~~~|
  | Request KPs   |               |               |
  |~~~~~~~~~~~~~~&gt;| /keyMaterial  |               |
  |               |--------------&gt;|               |
  |               |        200 OK |               |
  |           KPs |&lt;--------------|               |
  |&lt;~~~~~~~~~~~~~~|               |               |
  |               |               |               |

ClientB*-&gt;ServerB: [[ Store KeyPackages ]]
ClientA1-&gt;ServerA: [[ request KPs for bob@bravo.com ]]
ServerA-&gt;ServerB: POST /keyMaterial KeyMaterialRequest
ServerB: Verify that Alice is authorized to fetch KeyPackages
ServerB: Mark returned KPs as reserved for Alice’s use
ServerB-&gt;ServerA: 200 OK KeyMaterialResponse
ServerA: Remember that these KPs go to bravo.com
ServerA-&gt;ClientA1: [[ KPs ]]
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-alice-fetches-keypackages-f" class="selfRef">Alice Fetches KeyPackages for Bob's Clients</a>
          </figcaption></figure>
</div>
<span id="name-alice-adds-bob-to-the-room-"></span><div id="fig-ab-add">
<figure id="figure-3">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-3.2-7.1">
<pre>
ClientA1       ServerA         ServerB         ClientB*
  |               |               |               |
  | Commit, etc.  |               |               |
  |~~~~~~~~~~~~~~&gt;| /notify       |               |
  |               |--------------&gt;| Welcome, Tree |
  |               |               |~~~~~~~~~~~~~~&gt;|
  |               |               |~~~~~~~~~~~~~~&gt;|
  |               |        200 OK |               |
  |      Accepted |&lt;--------------|               |
  |&lt;~~~~~~~~~~~~~~|               |               |
  |               |               |               |

ClientA1: Prepare Commit over AppSync(+bob@bravo.com), Add*
ClientA1-&gt;ServerA: [[ Commit, Welcome, GroupInfo?, RatchetTree? ]]
ServerA: Verify that AppSync, Adds are allowed by policy
ServerA: Identifies Welcome domains based on KP hash in Welcome
ServerA-&gt;ServerB: POST /notify/clubhouse@alpha.com Intro{ Welcome, RatchetTree? }
ServerB: Recognizes that Welcome is adding Bob to room clubhouse@alpha.com
ServerB-&gt;ClientB*: [[ Welcome, RatchetTree? ]]
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-alice-adds-bob-to-the-room-" class="selfRef">Alice Adds Bob to the Room and Bob's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-adds-cathy-to-the-room">
<section id="section-3.3">
        <h3 id="name-bob-adds-cathy-to-the-room">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-bob-adds-cathy-to-the-room" class="section-name selfRef">Bob adds Cathy to the Room</a>
        </h3>
<p id="section-3.3-1">The process of adding Bob was a bit abbreviated because Alice is a user of the
hub service provider.  When Bob adds Cathy, we see the full process, involving
the same two steps (KP fetch followed by add), but this time indirected via the
hub server ServerA.  Also, now that there are users on ServerB involved in the
room, the hub ServerA will have to distribute the Commit adding Cathy and
Cathy's clients to ServerB as well as forwarding the Welcome to ServerC.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<span id="name-bob-fetches-keypackages-for"></span><div id="fig-bc-kp-fetch">
<figure id="figure-4">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-3.3-2.1">
<pre>
ClientB1       ServerB         ServerA         ServerC         ClientC*
  |               |               |               |               |
  |               |               |               |     Store KPs |
  |               |               |               |&lt;~~~~~~~~~~~~~~|
  |               |               |               |&lt;~~~~~~~~~~~~~~|
  | Request KPs   |               |               |               |
  |~~~~~~~~~~~~~~&gt;| /keyMaterial  | /keyMaterial  |               |
  |               |--------------&gt;|--------------&gt;|               |
  |               |        200 OK |        200 OK |               |
  |           KPs |&lt;--------------|&lt;--------------|               |
  |&lt;~~~~~~~~~~~~~~|               |               |               |
  |               |               |               |               |

ClientC*-&gt;ServerC: [[ Store KeyPackages ]]
ClientB1-&gt;ServerB: [[ request KPs for bob@bravo.com ]]
ServerB-&gt;ServerA: POST /keyMaterial KeyMaterialRequest
ServerA-&gt;ServerC: POST /keyMaterial KeyMaterialRequest
ServerB: Verify that Bob is authorized to fetch KeyPackages
ServerB: Mark returned KPs as reserved for Bob’s use
ServerC-&gt;ServerA: 200 OK KeyMaterialResponse
ServerA: Remember that these KPs go to bravo.com
ServerA-&gt;ServerB: 200 OK KeyMaterialResponse
ServerB-&gt;ClientB1: [[ KPs ]]
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-bob-fetches-keypackages-for" class="selfRef">Bob Fetches KeyPackages for Cathy's Clients</a>
          </figcaption></figure>
</div>
<span id="name-bob-adds-cathy-to-the-room-"></span><div id="fig-bc-add">
<figure id="figure-5">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-3.3-3.1">
<pre>
ClientB1       ServerB         ServerA         ServerC         ClientC*  ClientB*  ClientA*
  |               |               |               |               |         |         |
  | Commit, etc.  |               |               |               |         |         |
  |~~~~~~~~~~~~~~&gt;| /update       |               |               |         |         |
  |               |--------------&gt;|               |               |         |         |
  |               |        200 OK |               |               |         |         |
  |               |&lt;--------------|               |               |         |         |
  |      Accepted |               | /notify       |               |         |         |
  |&lt;~~~~~~~~~~~~~~|               |--------------&gt;| Welcome, Tree |         |         |
  |               |               |               |~~~~~~~~~~~~~~&gt;|         |         |
  |               |               |               |~~~~~~~~~~~~~~&gt;|         |         |
  |               |       /notify |               |               |         |         |
  |               |&lt;--------------|               |               |         |         |
  |               | Commit        |               |               |         |         |
  |               |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;|         |
  |               |               | Commit        |               |         |         |
  |               |               |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;|
  |               |               |               |               |         |         |

ClientB1: Prepare Commit over AppSync(+cathy@charlie.com), Add*
ClientB1-&gt;ServerB: [[ Commit, Welcome, GroupInfo?, RatchetTree? ]]
ServerB-&gt;ServerA: POST /update/clubhouse@alpha.com CommitBundle
ServerA: Verify that Adds are allowed by policy
ServerA-&gt;ServerB: 200 OK
ServerA-&gt;ServerC: POST /notify/clubhouse@alpha.com Intro{ Welcome, RatchetTree? }
ServerC: Recognizes that Welcome is adding Cathy to clubhouse@alpha.com
ServerC-&gt;ClientC*: [[ Welcome, RatchetTree? ]]
ServerA-&gt;ServerB: POST /notify/clubhouse@alpha.com Commit
ServerB-&gt;ClientB*: [[ Commit ]]
ServerA-&gt;ClientA*: [[ Commit ]]
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-bob-adds-cathy-to-the-room-" class="selfRef">Bob Adds Cathy to the Room and Cathy's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="cathy-sends-a-message">
<section id="section-3.4">
        <h3 id="name-cathy-sends-a-message">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-cathy-sends-a-message" class="section-name selfRef">Cathy Sends a Message</a>
        </h3>
<p id="section-3.4-1">Now that Alice, Bob, and Cathy are all in the room, Cathy wants to say hello to
everyone.  Cathy's client encapsulates the message in an MLS PrivateMessage and
sends it to ServerC, who forwards it to the hub ServerA on Cathy's behalf.
Assuming Cathy is allowed to speak in the room, ServerA will forward Cathy's
message to the other servers involved in the room, who distribute it to their
clients.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<span id="name-cathy-sends-a-message-to-th"></span><div id="fig-c-msg">
<figure id="figure-6">
          <div class="alignLeft art-ascii-art art-text artwork" id="section-3.4-2.1">
<pre>
ClientC1       ServerC         ServerA         ServerB         ClientB*  ClientC*  ClientA*
  |               |               |               |               |         |         |
  | Message       |               |               |               |         |         |
  |~~~~~~~~~~~~~~&gt;| /message      |               |               |         |         |
  |               |--------------&gt;|               |               |         |         |
  |               |        200 OK |               |               |         |         |
  |               |&lt;--------------|               |               |         |         |
  |      Accepted |               | /notify       |               |         |         |
  |&lt;~~~~~~~~~~~~~~|               |--------------&gt;| Message       |         |         |
  |               |               |               |~~~~~~~~~~~~~~&gt;|         |         |
  |               |       /notify |               |               |         |         |
  |               |&lt;--------------|               |               |         |         |
  |               | Message       |               |               |         |         |
  |               |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;|         |
  |               |               | Message       |               |         |         |
  |               |               |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;|
  |               |               |               |               |         |         |

ClientC1-&gt;ServerC: [[ MLSMessage(PrivateMessage) ]]
ServerC-&gt;ServerA: POST /message/clubhouse@alpha.com MLSMessage(PrivateMessage)
ServerA: Verifies that message is allowed
ServerA-&gt;ServerC: POST /notify/clubhouse@alpha.com Message{ MLSMessage(PrivateMessage) }
ServerA-&gt;ServerB: POST /notify/clubhouse@alpha.com Message{ MLSMessage(PrivateMessage) }
ServerA-&gt;ClientA*: [[ MLSMessage(PrivateMessage) ]]
ServerB-&gt;ClientB*: [[ MLSMessage(PrivateMessage) ]]
ServerC-&gt;ClientC*: [[ MLSMessage(PrivateMessage) ]]
</pre>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-cathy-sends-a-message-to-th" class="selfRef">Cathy Sends a Message to the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-leaves-the-room">
<section id="section-3.5">
        <h3 id="name-bob-leaves-the-room">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-bob-leaves-the-room" class="section-name selfRef">Bob Leaves the Room</a>
        </h3>
<p id="section-3.5-1">A user removing another user follows the same flow as adding the user.  They
user performing the removal creates an MLS commit covering Remove proposals for
all of the removed user's devices, and an AppSync proposal updating the room
state to remove the removed user from the room's participant list.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">Leaving is slightly more complicated because the leaving user cannot remove all
of their devices from the MLS group.  Instead, the leave happens in three steps:<a href="#section-3.5-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.5-3">
<li id="section-3.5-3.1">
            <p id="section-3.5-3.1.1">The leaving client constructs a Commit removing all of the user's other
devices, a Remove proposal for itself, and an AppSync proposal that removes
its user from the participant list.<a href="#section-3.5-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.2">
            <p id="section-3.5-3.2.1">The leaving client sends this Commit and proposals to the hub.  The hub
distributes the Commit to the room and caches the proposals.<a href="#section-3.5-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.3">
            <p id="section-3.5-3.3.1">The next time a client attempts to commit, the hub requires the client to
include the cached proposals.<a href="#section-3.5-3.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-3.5-4">The hub thus guarantees the leaving client that they will be removed as soon as
possible.<a href="#section-3.5-4" class="pilcrow">¶</a></p>
<span id="name-bob-leaves-the-room-2"></span><div id="fig-b-leave">
<figure id="figure-7">
          <div class="alignLeft art-text artwork" id="section-3.5-5.1">
<pre>
ClientB1       ServerB         ServerA         ServerC         ClientC1
  |               |               |               |               |
  | Commit, Prop+ |               |               |               |
  |~~~~~~~~~~~~~~&gt;| /update       |               |               |
  |               |--------------&gt;|               |               |
  |               |        200 OK |               |               |
  |               |&lt;--------------|               |               |
  |      Accepted |               |               |               |
  |&lt;~~~~~~~~~~~~~~|               |               |               |
  |               |       /notify | /notify       |               |
  |               |&lt;--------------|--------------&gt;|               |
  |               |               |               |        Commit |
  |               |               |               |&lt;~~~~~~~~~~~~~~|
  |               |               |       /update |               |
  |               |               |&lt;~~~~~~~~~~~~~~|               |
  |               |               | 401 Prop+     |               |
  |               |               |~~~~~~~~~~~~~~&gt;|               |
  |               |               |               | Reject(Prop+) |
  |               |               |               |~~~~~~~~~~~~~~&gt;|
  |               |               |               | Commit(Prop+) |
  |               |               |               |&lt;~~~~~~~~~~~~~~|
  |               |               |       /update |               |
  |               |               |&lt;~~~~~~~~~~~~~~|               |
  |               |               | 200 OK        |               |
  |               |               |--------------&gt;|               |
  |               |               |               | Accepted      |
  |               |               |               |~~~~~~~~~~~~~~&gt;|
  |               |       /notify | /notify       |               |
  |               |&lt;--------------|--------------&gt;|               |
  |               |               |               |               |

ClientB1: Prepare Commit over Remove*, Proposal for Remove(self), AppSync(-bob@bravo.com)
ClientB1-&gt;ServerB: [[ Commit, Welcome, GroupInfo?, RatchetTree? ]]
ServerB-&gt;ServerA: POST /update/clubhouse@alpha.com CommitBundle + Proposals
ServerA: Verify that Removes, AppSync are allowed by policy
ServerA-&gt;ServerB: 200 OK
ServerA-&gt;ServerB: POST /notify/clubhouse@alpha.com Commit
ServerA-&gt;ServerC: POST /notify/clubhouse@alpha.com Commit
ServerA-&gt;ClientA*: [[ Commit ]]
ServerB-&gt;ClientB*: [[ Commit ]]
ServerC-&gt;ClientC*: [[ Commit ]]
</pre>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-bob-leaves-the-room-2" class="selfRef">Bob Leaves the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
</section>
</div>
<div id="transport-layer">
<section id="section-4">
      <h2 id="name-transport-layer">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-transport-layer" class="section-name selfRef">Transport layer</a>
      </h2>
<ul class="normal">
<li class="normal" id="section-4-1.1">
          <p id="section-4-1.1.1">Server for user identified by domain half of identifier<a href="#section-4-1.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-1.2">
          <p id="section-4-1.2.1">HTTPS over mutually-authenticated TLS<a href="#section-4-1.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-1.3">
          <p id="section-4-1.3.1">Transport framing needs to identify intended src/dst domains<a href="#section-4-1.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-1.4">
          <p id="section-4-1.4.1">TLS certificates need to authenticate src/dst domains<a href="#section-4-1.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="e2e-security-layer">
<section id="section-5">
      <h2 id="name-e2e-security-layer">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-e2e-security-layer" class="section-name selfRef">E2E Security Layer</a>
      </h2>
<ul class="normal">
<li class="normal" id="section-5-1.1">
          <p id="section-5-1.1.1">All actions within a room are E2E-authenticated<a href="#section-5-1.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-1.2">
          <p id="section-5-1.2.1">Each room has an associated MLS group<a href="#section-5-1.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-1.3">
          <p id="section-5-1.3.1">Messages are protected as PrivateMessage<a href="#section-5-1.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-1.4">
          <p id="section-5-1.4.1">Room changes are protected as PublicMessage(Proposal)<a href="#section-5-1.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-1.5">
          <p id="section-5-1.5.1">... incl. origination by servers<a href="#section-5-1.5.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="application-layer">
<section id="section-6">
      <h2 id="name-application-layer">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-application-layer" class="section-name selfRef">Application Layer</a>
      </h2>
<div id="room-state">
<section id="section-6.1">
        <h3 id="name-room-state">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-room-state" class="section-name selfRef">Room State</a>
        </h3>
<p id="section-6.1-1">[[ Only room state right now is a list of participant IDs, MLS group ID ]]
[[ Hub and followers track KP hashes for Welcome routing ]]<a href="#section-6.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="application-endpoints">
<section id="section-6.2">
        <h3 id="name-application-endpoints">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-application-endpoints" class="section-name selfRef">Application Endpoints</a>
        </h3>
<p id="section-6.2-1">[[ keyMaterial / notify / update / message ]]
[[ Discovery from domain via .well-known ]]<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<div id="fetching-key-material-for-a-user">
<section id="section-6.2.1">
          <h4 id="name-fetching-key-material-for-a">
<a href="#section-6.2.1" class="section-number selfRef">6.2.1. </a><a href="#name-fetching-key-material-for-a" class="section-name selfRef">Fetching Key Material for a User</a>
          </h4>
<p id="section-6.2.1-1">### Updating Room State
### Notifying Followers of Room Events
### Sending Messages<a href="#section-6.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="mls-applicationsync-proposal">
<section id="section-7">
      <h2 id="name-mls-applicationsync-proposa">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-mls-applicationsync-proposa" class="section-name selfRef">MLS ApplicationSync Proposal</a>
      </h2>
<p id="section-7-1">[[ TODO: RLB ]]<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="consent-sketch">
<section id="section-8">
      <h2 id="name-consent-sketch">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-consent-sketch" class="section-name selfRef">Consent Sketch</a>
      </h2>
<p id="section-8-1">[[ Consent is important, so we include a preliminary sketch here ]]<a href="#section-8-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hedgedoc-content-below-this-line">
<section id="section-9">
      <h2 id="name-hedgedoc-content-below-this">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-hedgedoc-content-below-this" class="section-name selfRef">HEDGEDOC CONTENT BELOW THIS LINE</a>
    </h2>
</section>
</div>
<div id="operational-model">
<section id="section-10">
      <h2 id="name-operational-model">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-operational-model" class="section-name selfRef">Operational Model</a>
      </h2>
<p id="section-10-1">[[ RLB: This might be better to pull up into the architecture. ]]<a href="#section-10-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-2.1">
          <p id="section-10-2.1.1">Goal of MIMI protocol is to allow control of room state<a href="#section-10-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-2.2">
          <p id="section-10-2.2.1">State stored on hub for room<a href="#section-10-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-2.2.2.1">
              <p id="section-10-2.2.2.1.1">Confirmed state<a href="#section-10-2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10-2.2.2.2">
              <p id="section-10-2.2.2.2.1">List of outstanding proposals<a href="#section-10-2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10-2.2.2.3">
              <p id="section-10-2.2.2.3.1">Proposed state = Confirmed + proposals<a href="#section-10-2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li class="normal" id="section-10-2.3">
          <p id="section-10-2.3.1">Clients take action "in immediate mode" ~ Proposals + Commit<a href="#section-10-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-2.4">
          <p id="section-10-2.4.1">Some actions cannot be committed immediately<a href="#section-10-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-2.4.2.1">
              <p id="section-10-2.4.2.1.1">Self-remove<a href="#section-10-2.4.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10-2.4.2.2">
              <p id="section-10-2.4.2.2.1">Any action intiated by a server<a href="#section-10-2.4.2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li class="normal" id="section-10-2.5">
          <p id="section-10-2.5.1">If an action cannot be committed immediately, the hub enqueues it and assures it is committed as soon as possible<a href="#section-10-2.5.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-2.6">
          <p id="section-10-2.6.1">Some actions happen outside a room: Consent, claim key material, identifier resolution<a href="#section-10-2.6.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-10-3">Functional/layering model of MIMI protocol:<a href="#section-10-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-4.1">
          <p id="section-10-4.1.1">Transport ~ authenticated, request/response connection between servers<a href="#section-10-4.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-4.2">
          <p id="section-10-4.2.1">Identifier resolution request / response<a href="#section-10-4.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-4.3">
          <p id="section-10-4.3.1">Consent request / response<a href="#section-10-4.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-4.4">
          <p id="section-10-4.4.1">Room state change request / response<a href="#section-10-4.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-4.4.2.1">
              <p id="section-10-4.4.2.1.1">Proposal* + [CommitBundle]<a href="#section-10-4.4.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10-4.4.2.2">
              <p id="section-10-4.4.2.2.1">Proposal = Add / Update / Remove / MIMI<a href="#section-10-4.4.2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li class="normal" id="section-10-4.5">
          <p id="section-10-4.5.1">Message submission request / response<a href="#section-10-4.5.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-10-5"><code>
                   +---------------+-------------+
                   | MIMI Proposal | Content Fmt |
+--------+---------+---------------+-------------+
| ID res | Consent | State Change  | Submission  |
+--------+---------+---------------+-------------+
|                    Transport                   |
+------------------------------------------------+
</code>
```
POST /updateRoom/dxzxxDuvMOTsUD4D_YdSyQ<a href="#section-10-5" class="pilcrow">¶</a></p>
<p id="section-10-6">PublicMessage{
  /* MLS Commit - inside is a list of Proposals <em>/
  Commit[
    AppSync{
      addUsers [
        [Charlie, [normal]],
        [Doug, [normal,admin]]
      ]
      updateUsers [],
      removeUsers [Bob]
    },
    Add(Charlie1),
    Add(Doug1),
    Add(Doug2),
    Remove(Bob1),
    Remove(Bob2),
    Remove(Bob3)
  ],
  /</em> MLS Welcome encrypted for Charlie1, Doug1, Doug2 <em>/
  Welcome
  /</em> MLS GroupInfo if the Commit is accepted (without the ratchet_tree)
  GroupInfo,
  /*
  RatchetTree
}
```<a href="#section-10-6" class="pilcrow">¶</a></p>
<p id="section-10-7">Removing yourself
```
POST /updateRoom/dxzxxDuvMOTsUD4D_YdSyQ<a href="#section-10-7" class="pilcrow">¶</a></p>
<p id="section-10-8">/* concatenated MLS Proposals (each inside a PublicMessage) */
AppSync{
  removeUsers [Alice]
},
Remove(Alice1),
SelfRemove(Alice2),
Remove(Alice3)<a href="#section-10-8" class="pilcrow">¶</a></p>
<p id="section-10-9">```<a href="#section-10-9" class="pilcrow">¶</a></p>
<p id="section-10-10">Charlie1 commits Alice's pending proposals. This is accepted even though Charlie wouldn't have permission to remove Alice himself.
```
POST /updateRoom/dxzxxDuvMOTsUD4D_YdSyQ<a href="#section-10-10" class="pilcrow">¶</a></p>
<p id="section-10-11">PublicMessage{
  /* MLS Commit - inside is a list of Proposals <em>/
  Commit[
    AppSync{
      removeUsers [Alice]
    },
    Remove(Alice1),
    SelfRemove(Alice2),
    Remove(Alice3)
  ],
  /</em> No MLS Welcome  <em>/
  /</em> MLS GroupInfo if the Commit is accepted (without the ratchet_tree) <em>/
  GroupInfo,
  /</em> ratchet_tree or some other representation */
  RatchetTree
}
```<a href="#section-10-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="abcs-of-the-protocol">
<section id="section-11">
      <h2 id="name-abcs-of-the-protocol">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-abcs-of-the-protocol" class="section-name selfRef">ABCs of the Protocol</a>
      </h2>
<p id="section-11-1">The MIMI transport protocol is designed to allow users of instant messaging
on different providers to participate together in group chats using
a common end-to-end encryption protocol and content format. It does not specify the transport protocol between clients and their providers, but it does
constrain them to faithfully implement the end-to-end encryption protocol and the MIMI content format.<a href="#section-11-1" class="pilcrow">¶</a></p>
<p id="section-11-2">We explain the protocol by walking through various scenarios, starting with the most commonly used. First we will show how Alice adds Bob to an existing room. For this case we assume that Room1 exists and Alice is room administrator (she can add and remove users and change roles), Alice already has a stable identifier for the user Bob, and that Bob has somehow indicated consent for Alice to add him to this room (or rooms in general).<a href="#section-11-2" class="pilcrow">¶</a></p>
<p id="section-11-3">Throughout this section, we will detail the individual operations from the
perspective of the user Alice. All actions by Alice are taken through Alice's
client and her server's proprietary API. While some parts of the individual
messages originate from Alice's clients, the MIMI protocol is only concerned
with the communication between Alice's, Bob's and Cathy's servers. So whenever
users are referenced throughout this section, it is implied that they are
communicating with their respective servers, which then communicate with
one another.<a href="#section-11-3" class="pilcrow">¶</a></p>
<div id="dramatis-personae">
<section id="section-11.1">
        <h3 id="name-dramatis-personae">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-dramatis-personae" class="section-name selfRef">Dramatis Personae</a>
        </h3>
<ul class="normal">
<li class="normal" id="section-11.1-1.1">
            <p id="section-11.1-1.1.1">Alice, Bob: Users<a href="#section-11.1-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.1-1.2">
            <p id="section-11.1-1.2.1">Alice1, Alice2, etc. are Alice's devices; likewise for Bob and other users<a href="#section-11.1-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.1-1.3">
            <p id="section-11.1-1.3.1">ProviderA is Alice's provider, ProviderB is Bob's provider, etc.<a href="#section-11.1-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.1-1.4">
            <p id="section-11.1-1.4.1">Room1 is a room in which the users are interacting<a href="#section-11.1-1.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="alice-creates-a-room-1">
<section id="section-11.2">
        <h3 id="name-alice-creates-a-room-2">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-alice-creates-a-room-2" class="section-name selfRef">Alice creates a room</a>
        </h3>
<p id="section-11.2-1">We assume that someone on ProviderA (possibly Alice) has created Room1, that ProviderA is the <em>hub provider</em> for the room, and that the room policy means that if you have the "admin" role in the room you can add and remove users to the participant list and change the roles of participants.<a href="#section-11.2-1" class="pilcrow">¶</a></p>
<p id="section-11.2-2">Creating a room is done between a client and its local provider and is
out of scope of MIMI. However, we assume that Room1 has the following
policies.<a href="#section-11.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11.2-3.1">
            <p id="section-11.2-3.1.1">the room is for members only;<a href="#section-11.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.2-3.2">
            <p id="section-11.2-3.2.1">the room is not moderated;<a href="#section-11.2-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.2-3.3">
            <p id="section-11.2-3.3.1">multiple MLS clients are allowed for each user;<a href="#section-11.2-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-11.2-3.4">
            <p id="section-11.2-3.4.1">the administrator and owner roles are allowed to add and remove users, and to promote a user to be an administrator.<a href="#section-11.2-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-11.2-4">We also assume that Alice is the owner, and therefore an administrator,
of the room. Alice has owner, administrator, and regular user roles in the room.<a href="#section-11.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-bob">
<section id="section-11.3">
        <h3 id="name-alice-adds-bob">
<a href="#section-11.3" class="section-number selfRef">11.3. </a><a href="#name-alice-adds-bob" class="section-name selfRef">Alice adds Bob</a>
        </h3>
<div id="alice-gets-initial-keying-material-for-bob">
<section id="section-11.3.1">
          <h4 id="name-alice-gets-initial-keying-m">
<a href="#section-11.3.1" class="section-number selfRef">11.3.1. </a><a href="#name-alice-gets-initial-keying-m" class="section-name selfRef">Alice gets initial keying material for Bob</a>
          </h4>
<p id="section-11.3.1-1">In end-to-end encryption protocols, there is typiclly some type of initial ephemeral keying material which clients generate. Clients often upload this keying information in care of their provider. This keying information is almost always designed to be used only once. In MLS this initial keying information is called
a KeyPackage. We use the terminology "claim" to exclusively reserve keying information from the target user's provider.<a href="#section-11.3.1-1" class="pilcrow">¶</a></p>
<p id="section-11.3.1-2">In MLS, in order for Alice to add Bob, her client needs to somehow obtain a KeyPackage unique for each group, for each of Bob's clients. In MLS, two rooms with the same client have separate keying information for that client, so even if Bob is already in another group with Alice, her client needs Bob's KeyPackages to add his clients to a new group.<a href="#section-11.3.1-2" class="pilcrow">¶</a></p>
<p id="section-11.3.1-3">To create a conversation with Bob, Alice would like to get KeyPackages for all
of Bob's clients (for example for clients on his laptop, his phone, and his tablet). Alice's client requests Bob's KeyPackages from her local provider (not specified by MIMI), then her provider sends a request to Bob's provider asking for KeyPackages for Bob's clients. That request may include the
room ID in which Alice intends to use the KeyPackages, in case Bob's consent
only applies to a single room.<a href="#section-11.3.1-3" class="pilcrow">¶</a></p>
<p id="section-11.3.1-4"><code>
Bob* -&gt; ProviderB: KeyPackage
Alice1 -&gt; ProviderA: Get key material for Bob@B in Room1
ProviderA -&gt; ProviderB: KeyMaterialRequest(Bob@B in Room1)
ProviderB -&gt; ProviderA: KeyMaterialResponse(Bob1, Bob2, Bob3)
ProviderA -&gt; Alice1: KeyPackages for Bob1, Bob2, Bob3
</code><a href="#section-11.3.1-4" class="pilcrow">¶</a></p>
<p id="section-11.3.1-5">Like all operations that are not authorized based on room policy, claiming a key material is subject to complying with Bob's consent policy (often as delegated to Bob's provider). Consent is discussed more in [[consent section]]. For the purpose of this simple example, we assume that Alice already has appropriate consent.<a href="#section-11.3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-bob-to-the-participant-list-and-mls-group">
<section id="section-11.3.2">
          <h4 id="name-alice-adds-bob-to-the-parti">
<a href="#section-11.3.2" class="section-number selfRef">11.3.2. </a><a href="#name-alice-adds-bob-to-the-parti" class="section-name selfRef">Alice adds Bob to the participant list and MLS group</a>
          </h4>
<p id="section-11.3.2-1">In MIMI, the room policy consists of the base policy (which can refer to roles,
but does not refer to specific participants), the participant list, and the
cryptographic state of the end-to-end protocol (in MLS, the corresponding MLS
group state). The participant list also contains the roles associated with each
participant.<a href="#section-11.3.2-1" class="pilcrow">¶</a></p>
<p id="section-11.3.2-2">The base policy is expected to be modified infrequently and therefore it can
only be updated in its entirety. The participant list, however is expected to
change frequently in busy rooms. Each change to the participant list contains
a list of users who are added (with their roles), a list of users who are removed, and a list of
users whose roles have changed.<a href="#section-11.3.2-2" class="pilcrow">¶</a></p>
<p id="section-11.3.2-3">In MLS, the base policy document is communicated in an MLS GroupContext
extension. Any change to the base policy document (which is likely to be rare)
is made by committing an MLS GroupContextExtensions proposal.<a href="#section-11.3.2-3" class="pilcrow">¶</a></p>
<p id="section-11.3.2-4">Changes to the participant list are maintained by patching the participation
list. In MLS this accomplished by committing a <code>AppSync</code> proposal
(defined in this document).<a href="#section-11.3.2-4" class="pilcrow">¶</a></p>
<p id="section-11.3.2-5">Unless the base policy document defines otherwise, an MLS client who makes a
change to the participant list is expected to simultaneously effect the
corresponding change to the MLS group state (to the extent allowed by the
protocol). Except for active participants committing valid pending remove
proposals, a client making a change to the participant list should not expect
any other client to take any immediate action based on updating the participant
list alone.<a href="#section-11.3.2-5" class="pilcrow">¶</a></p>
<p id="section-11.3.2-6">Making any of these changes, the client sends either a set of proposals,
or sends a Commit bundle, which consists of a Commit, a Welcome if there were
any new clients added, a GroupInfo, and any changes to the ratchet tree. This is
described in more detail in the syntax section.<a href="#section-11.3.2-6" class="pilcrow">¶</a></p>
<p id="section-11.3.2-7">If Alice wants to add Bob, her client generates an MLS commit
with a <code>AppSync</code> proposal adding Bob as a participant and <code>Add</code>
proposals for each of Bob's clients; and an MLS Welcome message including Bob's clients. Between Alice's client and Alice's provider they also must insure Alice's provider (which is the hub for this room) has the GroupInfo and ratchet tree for the room if the commit is accepted. If the hub provider accepts this "commit bundle", it will forward (fan out) the commit to the current members of the MLS group, and forward a welcome message to any new MLS clients just added to the group.<a href="#section-11.3.2-7" class="pilcrow">¶</a></p>
<p id="section-11.3.2-8">Note that there are other ways for Bob to eventually participate in the room, but the method just dicsussed is the most straightforward and is preferred. Alice could commit a <code>AppSync</code>
just adding Bob as an inactive participant, and may need to if she cannot obtain
KeyPackages for Bob's clients (for example, if she is waiting for consent from
Bob), but Alice should not expect another participant, Bob, or some provider to
react to Bob being added, unless some specific policy arrangement is specified
in the base policy.<a href="#section-11.3.2-8" class="pilcrow">¶</a></p>
<p id="section-11.3.2-9"><code>
Alice1 -&gt; ProviderA: CommitBundle(PLP, Add*)
ProviderA: Validate commit sequencing; PLP authz by policy; Add authz by PL
ProviderA -&gt; Alice1: Commit accepted
</code><a href="#section-11.3.2-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-and-bob-exchange-messages">
<section id="section-11.3.3">
          <h4 id="name-alice-and-bob-exchange-mess">
<a href="#section-11.3.3" class="section-number selfRef">11.3.3. </a><a href="#name-alice-and-bob-exchange-mess" class="section-name selfRef">Alice and Bob exchange messages</a>
          </h4>
<p id="section-11.3.3-1">Any of Alice's or Bob's clients can try to send a instant message to the room. For an MLS room, Alice's or Bob's provider just sends the appropriate MLS application message to the hub provider. The hub provider verifies that the sender is an active participant of the room (and therefore a member of the corresponding MLS group), has permission to send messages in the room, and is valid according to some other MLS-specific checks.<a href="#section-11.3.3-1" class="pilcrow">¶</a></p>
<p id="section-11.3.3-2">If the hub accepts the message, it fans the message out to any other providers (and to its local clients).<a href="#section-11.3.3-2" class="pilcrow">¶</a></p>
<p id="section-11.3.3-3"><code>
Alice1 -&gt; ProviderA: Submit message
ProviderA: Validate message (e.g., Alice authz to send)
ProviderA -&gt; Alice*: Message notification
ProviderA -&gt; ProviderB: Message notification
ProviderB -&gt; Bob*: Message notification
</code><a href="#section-11.3.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="alice-makes-bob-a-room-administrator">
<section id="section-11.4">
        <h3 id="name-alice-makes-bob-a-room-admi">
<a href="#section-11.4" class="section-number selfRef">11.4. </a><a href="#name-alice-makes-bob-a-room-admi" class="section-name selfRef">Alice makes Bob a room administrator</a>
        </h3>
<p id="section-11.4-1">Digress to talk about room policy here...<a href="#section-11.4-1" class="pilcrow">¶</a></p>
<p id="section-11.4-2">Since Alice is the owner of the room and the room policy is that administrators have to Alice commits a <code>AppSync</code> proposal updating Bob's roles in the room to <code>[regular_user, admin]</code>.<a href="#section-11.4-2" class="pilcrow">¶</a></p>
<p id="section-11.4-3">If the hub provider accepts the commit, it fans it out so all the active participants receive it.<a href="#section-11.4-3" class="pilcrow">¶</a></p>
<p id="section-11.4-4"><code>
Alice1 -&gt; ProviderA: CommitBundle(PLP)
ProviderA: Validate commit sequencing; PLP authz by policy
ProviderA -&gt; Alice1: Commit accepted
</code>
## Bob adds Cathy and Doug<a href="#section-11.4-4" class="pilcrow">¶</a></p>
<p id="section-11.4-5">Since Bob is now an admin, Bob wants to Cathy and Doug. Bob starts by fetching their KeyPackages (assuming Bob already has consent from Cathy and Doug). Then Bob commits a <code>AppSync</code> proposal adding Cathy as both a regular user and administrator, and Doug as a regular user; and Add proposals for all of Cathy's and Doug's KeyPackages.<a href="#section-11.4-5" class="pilcrow">¶</a></p>
<p id="section-11.4-6">If the hub provider accepts the commit, it fans it out so all the active participants receive it, and also forwards the welcome message to Cathy's and Doug's providers.<a href="#section-11.4-6" class="pilcrow">¶</a></p>
<p id="section-11.4-7">Once any of the other clients in group receive the commit, or the newcomers receive the welcome, that client can send a message which will be received by the newcomers (assuming it is acceptable to the hub provider).<a href="#section-11.4-7" class="pilcrow">¶</a></p>
<p id="section-11.4-8"><code>
Bob1 -&gt; ProviderB: Get key material for Cathy@C and Doug@D in Room1
ProviderA -&gt; ProviderA (Hub): KeyMaterialRequest([Cathy], C, for Room1)
ProviderA -&gt; ProviderA (Hub): KeyMaterialRequest([Doug], D, for Room1)
ProviderA -&gt; ProviderC: KeyMaterialRequest(Cathy@C in Room1)
ProviderC -&gt; ProviderB: KeyMaterialResponse(Cathy1, Cathy2)
ProviderB -&gt; ProviderD: KeyMaterialRequest(Doug@C in Room1)
ProviderD -&gt; ProviderB: KeyMaterialResponse(Doug1)
ProviderB -&gt; Bob1: Key material(Cathy1, Cathy2, Doug1)
Bob1 -&gt; ProviderB: Commit(PLP, Add(C1, C2, D1)) + Welcome
ProviderB -&gt; ProviderA: CommitBundle(Commit(PLP, Add(C1, C2, D1)),Welcome, GroupInfo, ratchet_tree)
ProviderA: Validate commit sequencing; PLP authz by policy; Add authz by PL
ProviderA -&gt; ProviderB: Commit accepted
ProviderB -&gt; Bob: Commit accepted
ProviderA -&gt; Alice*: Commit
ProviderA -&gt; ProviderB: Commit
ProviderA -&gt; ProviderC: Commit
ProviderA -&gt; ProviderD: Commit
ProviderB -&gt; Bob's other clients: Commit
ProviderC -&gt; Cathy*: Commit
ProviderD -&gt; Doug*: Commit
</code><a href="#section-11.4-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bob-leaves-the-room-1">
<section id="section-11.5">
        <h3 id="name-bob-leaves-the-room-3">
<a href="#section-11.5" class="section-number selfRef">11.5. </a><a href="#name-bob-leaves-the-room-3" class="section-name selfRef">Bob leaves the room</a>
        </h3>
<p id="section-11.5-1">Removing oneself from a room deserves a special mention. In MLS a client cannot send a commit which removes itself from the group. Instead the leaver needs to send proposals that will be committed by a remaining member of the group.<a href="#section-11.5-1" class="pilcrow">¶</a></p>
<p id="section-11.5-2">Bob sends a single <code>AppSync</code> proposal
removing himself, a <code>SelfRemove</code> proposal for his initiating client, and <code>Remove</code> proposals for any of his other clients. An active participant then sends a commit referencing all those proposals together in a timely fashion.<a href="#section-11.5-2" class="pilcrow">¶</a></p>
<p id="section-11.5-3">If the commit is accepted by the hub provider, Bob's clients all receive the commit message, so they are aware that they have been removed. This is safe to do because they no longer have the information nececssary to calculate the new decryption key for the group, as it was encrypted only to the remaining members of the group.<a href="#section-11.5-3" class="pilcrow">¶</a></p>
<p id="section-11.5-4"><code>
Bob2 -&gt; ProviderB: CommitBundle(Rem(B1, B3)); ProposalBundle(Rem(B2), PLP)
ProviderB -&gt; ProviderA: CommitBundle(Rem(B1, B2, B3), PLP)
ProviderA: Validate commit sequencing; PLP authz by policy; Rem authz by PL
ProviderA: Enqueue Rem(B2), PLP
ProviderA: [[ fanout Commit ]]
</code><a href="#section-11.5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cathy-removes-doug">
<section id="section-11.6">
        <h3 id="name-cathy-removes-doug">
<a href="#section-11.6" class="section-number selfRef">11.6. </a><a href="#name-cathy-removes-doug" class="section-name selfRef">Cathy removes Doug</a>
        </h3>
<p id="section-11.6-1">For Cathy to remove Doug, she commits a <code>AppSync</code> proposal removing Doug, and <code>Remove</code> proposals for each of Doug's clients. Assuming the commit is accepted by the hub, both Doug's clients and the remaining members of the group recieve the commit, but Doug's clients can no longer decrypt messages sent for the group.<a href="#section-11.6-1" class="pilcrow">¶</a></p>
<p id="section-11.6-2"><code>
(similar Commit flow)
</code><a href="#section-11.6-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cathy-gets-a-new-client">
<section id="section-11.7">
        <h3 id="name-cathy-gets-a-new-client">
<a href="#section-11.7" class="section-number selfRef">11.7. </a><a href="#name-cathy-gets-a-new-client" class="section-name selfRef">Cathy gets a new client</a>
        </h3>
<p id="section-11.7-1">When a user is already a participant of a room, but a specific client is not yet a member of the corresponding MLS group, the client can join by generating an external commit and sending it and the rest of the commit bundle to the hub provider for the room. To construct an external commit, the client needs to first obtain the current GroupInfo object and the <code>ratchet_tree</code> for the group. Being an existing participant in the room is a simple way to authorize getting a GroupInfo object.<a href="#section-11.7-1" class="pilcrow">¶</a></p>
<p id="section-11.7-2"><code>
Cathy3 -&gt; ProviderC: Request to join [proof of identity]
ProviderC -&gt; ProviderA: Request to join [proof of idenitty]
ProviderA -&gt; ProviderC: GroupInfo
ProviderC -&gt; Cathy3: GroupInfo
Cathy3 -&gt; ProviderC: CommitBundle()
ProviderC -&gt; ProviderA: CommitBundle()
ProviderA: Validate commit sequencing; external commit authz by PL
ProviderA -&gt; ProviderC: Commit accepted
ProviderC -&gt; Cathy3: Commit accepted
ProviderA -&gt; ProviderB, ProviderC, ProviderD: Commit notification
ProviderA -&gt; Alice*: Commit notification
ProviderB -&gt; Bob*: Commit notification
ProviderD -&gt; Doug*: Commit notification
</code><a href="#section-11.7-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="consent">
<section id="section-11.8">
        <h3 id="name-consent">
<a href="#section-11.8" class="section-number selfRef">11.8. </a><a href="#name-consent" class="section-name selfRef">Consent</a>
        </h3>
<p id="section-11.8-1">Most instant messaging systems have some notion of how a user consents to be added to a room, and how they manipulate this consent.<a href="#section-11.8-1" class="pilcrow">¶</a></p>
<p id="section-11.8-2">In the connection-oriented model, once two users are connected, either user can add the other to any number of rooms. In other systems (often with many large and/or public rooms), a user needs to consent individually to be added to a room.<a href="#section-11.8-2" class="pilcrow">¶</a></p>
<p id="section-11.8-3">The MIMI consent mechanism supports both models and allows them to coexist. It allows a user to request consent, grant consent, revoke consent, and cancel a request for consent. Each of these consent operations can indicate a specific room, or indicate any room.<a href="#section-11.8-3" class="pilcrow">¶</a></p>
<p id="section-11.8-4">A connection grant or revoke does not need to specify a room if a connection request did, or vice versa. A connection grant or revoke does not even need to follow a connection request.<a href="#section-11.8-4" class="pilcrow">¶</a></p>
<p id="section-11.8-5">For example, Alice could ask for consent to add Bob to a specific room. Bob could send a connection grant for Alice to add him to any room, or a connection revoke preventing Alice from adding him to any room. Similarly, Alice might have sent a connection request to add Bob for any room (as a connection request), which Bob ignored or did not see. Later, Bob wants to join a specific room administered by Alice. Bob sends a connection grant for the specific room for Alice and sends a Knock request to Alice asking to be added. Finally, Cathy could send a connection grant for Bob (even if Bob did not initiate a connection request to Cathy), and Alice could recognize Cathy on the system and send a connection revoke for her preemptively.<a href="#section-11.8-5" class="pilcrow">¶</a></p>
<p id="section-11.8-6"><strong>NOTE:</strong> Many providers use additional factors to apply default consent within their service such as a user belonging to a specific workgroup or employer, participating in a related room (ex: WhatsApp "communities"), or presence of a user in the other user's contact list. MIMI does not need to provide a way to replicate or describe these supplemental mechanisms, since they are strongly linked to specific provider policies.<a href="#section-11.8-6" class="pilcrow">¶</a></p>
<p id="section-11.8-7">Consent requests have sensitive privacy implications. The sender of a consent request should receive an acknowledgement that the request was received by the <em>provider</em> of the target user. For privacy reasons, the requestor should not know if the target user received or viewed the request. The original requestor will obviously find out if the target grants consent, but a consent revocation/rejection is typically not communicated to the revoked/rejected user (again for privacy reasons).<a href="#section-11.8-7" class="pilcrow">¶</a></p>
<p id="section-11.8-8">Consent operations are only sent directly between the acting provider (sending the request, grant, revoke, or cancel) and the target provider (the object of the consent). In other words, the two providers must have a direct peering relationship.<a href="#section-11.8-8" class="pilcrow">¶</a></p>
<p id="section-11.8-9">In our example, Alice requests consent from Bob for any room. Later, Bob sends a grants consent to Alice to add him to any room. At the same time as sending the consent request, Alice grants consent to Bob to add her to any room.<a href="#section-11.8-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="other-ways-to-join">
<section id="section-11.9">
        <h3 id="name-other-ways-to-join">
<a href="#section-11.9" class="section-number selfRef">11.9. </a><a href="#name-other-ways-to-join" class="section-name selfRef">Other ways to join</a>
        </h3>
<p id="section-11.9-1">[[ RWM: TBC ]]<a href="#section-11.9-1" class="pilcrow">¶</a></p>
<div id="joining-with-an-join-url-code">
<section id="section-11.9.1">
          <h4 id="name-joining-with-an-join-url-co">
<a href="#section-11.9.1" class="section-number selfRef">11.9.1. </a><a href="#name-joining-with-an-join-url-co" class="section-name selfRef">Joining with an join URL / code</a>
        </h4>
</section>
</div>
<div id="joining-an-open-room">
<section id="section-11.9.2">
          <h4 id="name-joining-an-open-room">
<a href="#section-11.9.2" class="section-number selfRef">11.9.2. </a><a href="#name-joining-an-open-room" class="section-name selfRef">Joining an open room</a>
        </h4>
</section>
</div>
<div id="knocks">
<section id="section-11.9.3">
          <h4 id="name-knocks">
<a href="#section-11.9.3" class="section-number selfRef">11.9.3. </a><a href="#name-knocks" class="section-name selfRef">Knocks</a>
        </h4>
</section>
</div>
<div id="invites">
<section id="section-11.9.4">
          <h4 id="name-invites">
<a href="#section-11.9.4" class="section-number selfRef">11.9.4. </a><a href="#name-invites" class="section-name selfRef">Invites</a>
        </h4>
</section>
</div>
</section>
</div>
<div id="reporting-abusespam">
<section id="section-11.10">
        <h3 id="name-reporting-abuse-spam">
<a href="#section-11.10" class="section-number selfRef">11.10. </a><a href="#name-reporting-abuse-spam" class="section-name selfRef">Reporting abuse/spam</a>
        </h3>
<p id="section-11.10-1">[[ RWM: TBC ]]<a href="#section-11.10-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-sends-an-attachment-which-cathy-downloads">
<section id="section-11.11">
        <h3 id="name-alice-sends-an-attachment-w">
<a href="#section-11.11" class="section-number selfRef">11.11. </a><a href="#name-alice-sends-an-attachment-w" class="section-name selfRef">Alice sends an attachment which Cathy downloads</a>
        </h3>
<p id="section-11.11-1">[[ RWM: TBC ]]<a href="#section-11.11-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="getting-the-internal-identitifier-for-a-user">
<section id="section-11.12">
        <h3 id="name-getting-the-internal-identi">
<a href="#section-11.12" class="section-number selfRef">11.12. </a><a href="#name-getting-the-internal-identi" class="section-name selfRef">Getting the internal identitifier for a user</a>
        </h3>
<p id="section-11.12-1">[[ RWM: TBC ]]<a href="#section-11.12-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="moderation">
<section id="section-11.13">
        <h3 id="name-moderation">
<a href="#section-11.13" class="section-number selfRef">11.13. </a><a href="#name-moderation" class="section-name selfRef">Moderation</a>
        </h3>
<p id="section-11.13-1">out of scope<a href="#section-11.13-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="definition-of-primitives">
<section id="section-12">
      <h2 id="name-definition-of-primitives">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-definition-of-primitives" class="section-name selfRef">Definition of Primitives</a>
      </h2>
<div id="mimi-url-directory">
<section id="section-12.1">
        <h3 id="name-mimi-url-directory">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-mimi-url-directory" class="section-name selfRef">MIMI URL directory</a>
        </h3>
<p id="section-12.1-1">Like the ACME protocol <span>[<a href="#RFC8555" class="cite xref">RFC8555</a>]</span>, the MIMI protocol uses a directory document to convey the HTTPS URLs used to reach certain endpoints (as opposed to hard coding the endpoints).<a href="#section-12.1-1" class="pilcrow">¶</a></p>
<p id="section-12.1-2">The directory URL is discovered using the <code>mimi-protocol-directory</code> well-known URI.<a href="#section-12.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.1-3">
<pre>
GET /.well-known/mimi-protocol-directory
</pre><a href="#section-12.1-3" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-12.1-4">
<pre>
enum {
  get(1),
  post(2),
  (255)
} HttpMethod;

enum {
  requestConsent(1),
  updateConsent(2),
  claimKeyMaterial(3),
  updateRoom(4),
  provisionalMessage(5),
  fanoutMessage(6),
  claimGroupInfo(7),
  downloadFile(8),
  reportAbuse(9),
  identifierQuery(10),
  (255)
} MimiPrimitive;

struct {
  MimiPrimitive primitive;
  HttpMethod method;
  HttpsUri uri;
} MimiDirectoryEntry;

struct {
  MimiDirectoryEntry directory&lt;V&gt;;
} MimiDirectory;
</pre><a href="#section-12.1-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="obtain-consent">
<section id="section-12.2">
        <h3 id="name-obtain-consent">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-obtain-consent" class="section-name selfRef">Obtain consent</a>
        </h3>
<p id="section-12.2-1">Alice can request consent for Bob in the context of a room, or in general. Bob can grant or refuse consent to Alice in the context of a room or in general.<a href="#section-12.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.2-2">
<pre>
POST /requestConsent/{targetDomain}
POST /updateConsent/{requesterDomain}

enum {
  cancel(0),
  request(1),
  grant(2),
  revoke(3),
  (255)
} ConsentOperation;

struct {
  ConsentOperation consentOperation;
  IdentifierUri requesterUri;
  IdentifierUri targetUri;
  optional&lt;RoomId&gt; roomId;
  select(consentOperation) {
      case grant:
          KeyPackage clientKeyPackages&lt;V&gt;;
  }
} ConsentEntry;
</pre><a href="#section-12.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="claim-keys">
<section id="section-12.3">
        <h3 id="name-claim-keys">
<a href="#section-12.3" class="section-number selfRef">12.3. </a><a href="#name-claim-keys" class="section-name selfRef">Claim keys</a>
        </h3>
<p id="section-12.3-1">This action attempts to claim initial keying material for all the clients
of a single user at a specific provider. The keying material may not be
reused unless identified as "last resort" keying material.<a href="#section-12.3-1" class="pilcrow">¶</a></p>
<p id="section-12.3-2">The target user's URI is listed in the request path. KeyPackages
requested using this primitive <span class="bcp14">MUST</span> be sent via the hub provider of whatever
room they will be used in. (If this is not the case, the hub provider will be
unable to forward a Welcome message to the target provider).<a href="#section-12.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.3-3">
<pre>
POST /keyMaterial/{targetUser}
</pre><a href="#section-12.3-3" class="pilcrow">¶</a>
</div>
<p id="section-12.3-4">The path includes the target user. The request body includes the protocol
(currently just MLS 1.0), and the requesting user. The request <span class="bcp14">SHOULD</span> include
the room ID for which the KeyPackage is intended, as the target may have only
granted consent for a specific room.<a href="#section-12.3-4" class="pilcrow">¶</a></p>
<p id="section-12.3-5">For MLS, the request includes a non-empty list of acceptable MLS ciphersuites,
and an MLS <code>RequiredCapabilities</code> object (which contains credential types,
non-default proposal types, and extensions) required by the requesting provider
(these lists can be an empty). The <code>lastResortAllowed</code> field <span class="bcp14">SHOULD</span> be false.<a href="#section-12.3-5" class="pilcrow">¶</a></p>
<p id="section-12.3-6">The request body has the following form.<a href="#section-12.3-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.3-7">
<pre>
enum {
    reserved(0),
    mls10(1),
    (255)
} Protocol;

struct {
    opaque uri&lt;V&gt;;
} IdentifierUri;

struct {
    Protocol protocol;
    IdentifierUri requestingUser;
    IdentifierUri targetUsers&lt;V&gt;;
    IdentifierUri roomId;
    select(protocol) {
        case mls10:
            CipherSuite acceptableCiphersuites&lt;V&gt;;
            RequiredCapabilities requiredCapabilities;
            bool lastResortAllowed;
    };
} KeyMaterialRequest;
</pre><a href="#section-12.3-7" class="pilcrow">¶</a>
</div>
<p id="section-12.3-8">A successful response contains a list of users.
For each user in the original request, there is a user status code that
indicates keying material was returned for all the user's clients (<code>success</code>),
that keying material was returned for some of their clients (<code>partialSuccess</code>),
or a specific user code indicating failure. If the user code is success or
partialSuccess, each client is enumerated in the response. Then for each client
with a <em>client</em> success code, the structure includes initial keying material (a
KeyPackage for MLS 1.0). If the client's code is <code>nothingCompatible</code>, the
client's capabilities are optionally included (The client's capabilities could
be omitted for privacy reasons.)<a href="#section-12.3-8" class="pilcrow">¶</a></p>
<p id="section-12.3-9">If the <em>user</em> code is <code>noCompatibleMaterial</code>, the provider <span class="bcp14">MAY</span> populate the
<code>clients</code> list. For any other user code, the provider <span class="bcp14">MUST NOT</span> populate the
<code>clients</code> list.<a href="#section-12.3-9" class="pilcrow">¶</a></p>
<p id="section-12.3-10">Keying material provided from one response <span class="bcp14">MUST NOT</span> be provided in any other
response unless the <code>lastResortAllowed</code> field was set in the requests.
The target provider <span class="bcp14">MUST NOT</span> provide expired keying material (ex: an MLS
KeyPackage containing a LeafNode with a <code>notAfter</code> time past the current date
and time).<a href="#section-12.3-10" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.3-11">
<pre>
enum {
    success(0);
    partialSuccess(1);
    incompatibleProtocol(2);
    noCompatibleMaterial(3);
    userUnknown(4);
    noConsent(5);
    noConsentForThisRoom(6);
    userDeleted(7);
    (255)
} KeyMaterialUserCode;

enum {
    success(0);
    keyMaterialExhausted(1);
    onlyLastResort(2);
    nothingCompatible(3);
    (255)
} KeyMaterialClientCode;


struct {
    KeyMaterialClientCode clientStatus;
    IdentifierUri clientUri;
    select(protocol) {
        case mls10:
            select(clientStatus) {
                case success:
                    KeyPackage keyPackage;
                case nothingCompatible:
                    optional&lt;Capabilities&gt; clientCapabilities;
            }
    };
} ClientKeyMaterial;

struct {
    Protocol protocol;
    KeyMaterialUserCode userStatus;
    IdentifierUri userUri;
    ClientKeyMaterial clients&lt;V&gt;;
} KeyMaterialResponse;
</pre><a href="#section-12.3-11" class="pilcrow">¶</a>
</div>
<p id="section-12.3-12">At minimum, as each MLS KeyPackage is returned to a requesting provider (on
behalf of a requesting IM client), the target provider needs to associate its
<code>KeyPackageRef</code> with the target client and the hub provider needs to associate
its <code>KeyPackageRef</code> with the target provider. This insures that Welcome
messages can be correctly routed to the target provider and client. These
associations can be deleted after a Welcome message is forwarded or after the
KeyPackage <code>leaf_node.lifetime.not_after</code> time has passed.<a href="#section-12.3-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="change-room-policyparticipation">
<section id="section-12.4">
        <h3 id="name-change-room-policy-particip">
<a href="#section-12.4" class="section-number selfRef">12.4. </a><a href="#name-change-room-policy-particip" class="section-name selfRef">Change room policy/participation</a>
        </h3>
<p id="section-12.4-1">Adds, removes, and policy changes to the room are all forms of updating the
room state. They are accomplished using the updateRoom transaction which is
used for updating the room base policy, participation list, or its underlying MLS group.<a href="#section-12.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.4-2">
<pre>
POST /updateRoom/{roomId}
</pre><a href="#section-12.4-2" class="pilcrow">¶</a>
</div>
<p id="section-12.4-3">In MLS 1.0, any change to the room base policy document is always expressed
using a <code>GroupContextExtensions</code> proposal. Likewise, any change to the
participant list is always communicated via a <code>AppSync</code>
proposal type. The participant list change needed to add a user <span class="bcp14">MUST</span> happen either before or simultaneously with the corresponding MLS operation.<a href="#section-12.4-3" class="pilcrow">¶</a></p>
<p id="section-12.4-4">Removing an active user from a participant list or banning an active participant <span class="bcp14">SHOULD</span> happen simultaneously with any MLS changes made to the commit removing the participant.<a href="#section-12.4-4" class="pilcrow">¶</a></p>
<p id="section-12.4-5">[[ RWM: TO REMOVE: "The provider is in an impossible situation handling users removed from the participation list but who are still active participants. It should forward the commit removing Bob as a participant to Bob's clients so that Bob is aware that it has been removed, but it should not forward the commit to Bob's clients because those clients would then be able to form the epoch secret for the new epoch." ]]<a href="#section-12.4-5" class="pilcrow">¶</a></p>
<p id="section-12.4-6">A hub provider which observes that an active user has been removed or banned, but still has clients <span class="bcp14">MUST</span> prevent any of those clients from sending or receiving any additional application messages; <span class="bcp14">MUST</span> prevent any of those clients from sending Commit messages; and <span class="bcp14">MUST</span> prevent it from sending any proposals except for <code>Remove</code> and <code>SelfRemove</code> proposals.<a href="#section-12.4-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.4-7">
<pre>
enum {
  reserved(0),
  system(1),
  owner(2),
  admin(3),
  regular_user(4),
  visitor(5),
  banned(6),
  (255)
} Role;

struct {
  IdentifierUri user;
  Role roles&lt;V&gt;;
} UserRoles;

struct {
    UserRoles addUsers&lt;V&gt;;
    UserRoles updateUsers&lt;V&gt;;
    IdentifierUri removeUsers&lt;V&gt;;
} AppSync;
</pre><a href="#section-12.4-7" class="pilcrow">¶</a>
</div>
<p id="section-12.4-8">Each user can be added with one or more roles. This list of roles can be
updated. Note that removing a user does not ban the user. To ban a user,
update their role to <code>banned</code>.<a href="#section-12.4-8" class="pilcrow">¶</a></p>
<p id="section-12.4-9">The updateRoom request body is described below:<a href="#section-12.4-9" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.4-10">
<pre>
select(room.protocol) {
  case mls10:
    PublicMessage proposalOrCommit;
      select (proposalOrCommit.content.content_type) {
        case commit:
          optional&lt;Welcome&gt; welcome;
          GroupInfo groupInfo;   /* without embedded ratchet_tree */
          RatchetTreeOption ratchetTreeOption;
        case proposal:
          PublicMessage moreProposals&lt;V&gt;; /* a list of additional proposals */
      };
};
</pre><a href="#section-12.4-10" class="pilcrow">¶</a>
</div>
<p id="section-12.4-11">In this case Alice creates a Commit containing a AppSync proposal adding
Bob@b.example, and Add proposals for all Bob's MLS clients.  Alice includes the
Welcome message which will be sent for Bob, a GroupInfo object for the hub
provider, and complete <code>ratchet_tree</code> extension.<a href="#section-12.4-11" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.4-12">
<pre>
enum {
  reserved(0),
  full(1),
  compressed(2),
  delta(3),
  patch(4),
  byReference(5)
  (255)
} RatchetTreeRepresentation;

struct {
  RatchetTreeRepresentation representation;
  select (representation) {
    case full:
      Node ratchet_tree&lt;V&gt;;
  };
} RatchetTreeOption;
</pre><a href="#section-12.4-12" class="pilcrow">¶</a>
</div>
<p id="section-12.4-13">The response body is described below:<a href="#section-12.4-13" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.4-14">
<pre>
enum {
  success(0),
  wrongEpoch(1),
  notAllowed(2),
  hubUnresponsive(3),
  invalidProposal(4),
  (255)
} UpdateResponseCode;

struct {
    UpdateResponseCode responseCode;
    string errorDescription;
} UpdateRoomResponse
</pre><a href="#section-12.4-14" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="send-provisional-message">
<section id="section-12.5">
        <h3 id="name-send-provisional-message">
<a href="#section-12.5" class="section-number selfRef">12.5. </a><a href="#name-send-provisional-message" class="section-name selfRef">Send provisional message</a>
        </h3>
<div class="alignLeft art-text artwork" id="section-12.5-1">
<pre>
POST /provisionalMessage/{roomId}
</pre><a href="#section-12.5-1" class="pilcrow">¶</a>
</div>
<p id="section-12.5-2">If the protocol is MLS 1.0, the request body is an MLSMessage with. a WireFormat of PrivateMessage (an application message).<a href="#section-12.5-2" class="pilcrow">¶</a></p>
<p id="section-12.5-3">The response merely indicates if the message was accepted by the hub
provider.<a href="#section-12.5-3" class="pilcrow">¶</a></p>
<p id="section-12.5-4"><strong>ISSUE:</strong> Do we want to offer a distinction between regular application messages and ephemeral applications messages (for example "is typing" notifications), which do not need to be queued at the target provider.<a href="#section-12.5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="fan-out-messages">
<section id="section-12.6">
        <h3 id="name-fan-out-messages">
<a href="#section-12.6" class="section-number selfRef">12.6. </a><a href="#name-fan-out-messages" class="section-name selfRef">Fan out messages</a>
        </h3>
<p id="section-12.6-1">If the hub provider accepts an application or handshake message (proposal or commit) message, it forward that message to all other providers with active participants in the room and all local clients which are active participants. This is described as fanning the message out. An MLS Welcome message is sent to the providers and local users associated with the <code>KeyPackageRef</code> values to which the bulk of the Welcome (the <code>encrypted_group_info</code>) was encrypted.<a href="#section-12.6-1" class="pilcrow">¶</a></p>
<p id="section-12.6-2">The hub provider also fans out any messages which originate from itself (ex: MLS External Proposals).<a href="#section-12.6-2" class="pilcrow">¶</a></p>
<p id="section-12.6-3">The hub can include multiple concatenated <code>FanoutMessage</code> objects relevant to the same room.<a href="#section-12.6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.6-4">
<pre>
POST /fanout/{roomId}
</pre><a href="#section-12.6-4" class="pilcrow">¶</a>
</div>
<div class="lang-tls sourcecode" id="section-12.6-5">
<pre>
struct {
  MLSMessage message;
  /* the hub acceptance time (in milliseconds from the UNIX epoch) */
  uint64 timestamp;
} FanoutMessage;
</pre><a href="#section-12.6-5" class="pilcrow">¶</a>
</div>
<p id="section-12.6-6">If the protocol is MLS 1.0, the request body is one or more of MLSMessage
with wire_format one of PrivateMessage (application message), PublicMessage
(Commit or Proposal), or Welcome.<a href="#section-12.6-6" class="pilcrow">¶</a></p>
<p id="section-12.6-7"><strong>NOTE:</strong> Correctly fanning out Welcome messages relies on the hub and target providers storing the <code>KeyPackageRef</code> of claimed KeyPackages.<a href="#section-12.6-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="claim-end-to-end-crypto-group-key-information">
<section id="section-12.7">
        <h3 id="name-claim-end-to-end-crypto-gro">
<a href="#section-12.7" class="section-number selfRef">12.7. </a><a href="#name-claim-end-to-end-crypto-gro" class="section-name selfRef">Claim end-to-end crypto group key information</a>
        </h3>
<p id="section-12.7-1">For Bob's new client to join the MLS group and therefore fully participate
in the room with Alice, Bob needs to fetch the MLS GroupInfo (or analogous).<a href="#section-12.7-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.7-2">
<pre>
POST /claimGroupInfo/{roomId}
</pre><a href="#section-12.7-2" class="pilcrow">¶</a>
</div>
<p id="section-12.7-3">In the case of MLS 1.0, Bob provides a credential proving his client's
real or pseudonymous identity (for permission to join the group).<a href="#section-12.7-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.7-4">
<pre>
struct {
  select (protocol) {
    case mls10:
      SignaturePublicKey requestingSignatureKey;
      Credential requestingCredential;
  };
} GroupInfoRequest;

</pre><a href="#section-12.7-4" class="pilcrow">¶</a>
</div>
<p id="section-12.7-5">The response body contains the GroupInfo and a way to get the ratchet_tree.<a href="#section-12.7-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.7-6">
<pre>
struct {
  GroupInfoCode status;
  select (protocol) {
    case mls10:
      GroupInfo groupInfo;   /* without embedded ratchet_tree */
      RatchetTreeOption ratchetTreeOption;
  };
} GroupInfoResponse;
</pre><a href="#section-12.7-6" class="pilcrow">¶</a>
</div>
<p id="section-12.7-7"><strong>ISSUE</strong>: What security properties are needed to protect a
GroupInfo object in the MIMI context are still under discussion. It is
possible that the requester only needs to prove possession of their private
key. The GroupInfo in another context might be sufficiently sensitive that
it should be encrypted from the end client to the hub provider (unreadable
by the local provider).<a href="#section-12.7-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="download-files">
<section id="section-12.8">
        <h3 id="name-download-files">
<a href="#section-12.8" class="section-number selfRef">12.8. </a><a href="#name-download-files" class="section-name selfRef">Download files</a>
        </h3>
<p id="section-12.8-1">[[ RWM: TBC ]]<a href="#section-12.8-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="report-abuse">
<section id="section-12.9">
        <h3 id="name-report-abuse">
<a href="#section-12.9" class="section-number selfRef">12.9. </a><a href="#name-report-abuse" class="section-name selfRef">Report abuse</a>
        </h3>
<p id="section-12.9-1">Abuse reports are only sent to the hub provider.<a href="#section-12.9-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.9-2">
<pre>
POST /reportAbuse/{roomId}
</pre><a href="#section-12.9-2" class="pilcrow">¶</a>
</div>
<div class="lang-tls sourcecode" id="section-12.9-3">
<pre>
struct {
  /* an application message (wire_format = private_message and */
  /* content_type = application) and the key and nonce to decrypt */
  /* just this single application message */
  MLSMessage
  bytes key;
  bytes nonce;
} AbusiveMessage;

struct {
  IdentifierURI reportingUser;
  IdentifierURI allegedAbuserURI;
  opaque group_id&lt;V&gt;;
  uint64 epoch;
  uint32 allegedAbuserLeafIndex;
  AbusiveMessage messages&lt;V&gt;;
  AbuseType reasonCode;
  string note;
  AbusiveMessage messages&lt;V&gt;;
} AbuseReport;
</pre><a href="#section-12.9-3" class="pilcrow">¶</a>
</div>
<p id="section-12.9-4">The response code only indicates if the abuse report was accepted, not if any specific automated or human action was taken.<a href="#section-12.9-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="find-internal-address">
<section id="section-12.10">
        <h3 id="name-find-internal-address">
<a href="#section-12.10" class="section-number selfRef">12.10. </a><a href="#name-find-internal-address" class="section-name selfRef">Find internal address</a>
        </h3>
<div class="alignLeft art-text artwork" id="section-12.10-1">
<pre>
GET /identifierQuery/{domain}
</pre><a href="#section-12.10-1" class="pilcrow">¶</a>
</div>
<p id="section-12.10-2">The request body is described as:<a href="#section-12.10-2" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.10-3">
<pre>
enum {
  reserved(0),
  handle(1),
  nick(2),
  email(3),
  phone(4),
  partialName(5),
  wholeProfile(6),
  oidcStdClaim(7),
  vcardField(8),
  (255)
} SearchIdentifierType;

struct {
  SearchIdentifierType searchType;
  string searchValue;
  select(type) {
    case oidcStdClaim:
      string claimName;
    case vcardField:
      string fieldName;
  };
} IdentifierRequest;
</pre><a href="#section-12.10-3" class="pilcrow">¶</a>
</div>
<p id="section-12.10-4">The response body is described as:<a href="#section-12.10-4" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-12.10-5">
<pre>
enum {
  success(0),
  notFound(1),
  ambiguous(2),
  forbidden(3),
  unsupportedField(4),
  (255)
} IdentifierQueryCode;

enum {
  reserved(0),
  oidcStdClaim(7),
  vcardField(8),
  (255)
} FieldSource;

struct {
  FieldSource fieldSource;
  string fieldName;
  opaque fieldValue&lt;V&gt;;
} ProfileField;

struct {
  IdentifierUri stableUri;
  ProfileField fields&lt;V&gt;;
} UserProfile;

struct {
  IdentifierQueryCode responseCode;
  IdentifierUri uri&lt;V&gt;;
  UserProfile foundProfiles&lt;V&gt;;
} IdentifierResponse;
</pre><a href="#section-12.10-5" class="pilcrow">¶</a>
</div>
<p id="section-12.10-6"><strong>TODO</strong>: The format of specific identifiers is discussed in
<span>[<a href="#I-D.mahy-mimi-identity" class="cite xref">I-D.mahy-mimi-identity</a>]</span>. Any specific conventions which are needed
should be merged into this document.<a href="#section-12.10-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="use-of-mls-dsas">
<section id="section-13">
      <h2 id="name-use-of-mls-ds-as">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-use-of-mls-ds-as" class="section-name selfRef">Use of MLS DS/AS</a>
      </h2>
<p id="section-13-1">MLS defines an abstract Delivery Server (DS) and Authentication Server (AS). This abstract functionality is split across all the MLS clients and the providers, but an important function is provided specifically by the hub provider. The hub is responsible for the ordering of messages, fanning messages out to the appropriate providers, and maintaining the GroupInfo so authorized clients can add themselves to groups using an external commit.<a href="#section-13-1" class="pilcrow">¶</a></p>
<p id="section-13-2">The MLS profile for MIMI requires a concept of a user identifier and a mechanism to associate credentials in MLS clients to MIMI users.<a href="#section-13-2" class="pilcrow">¶</a></p>
<p id="section-13-3">Clients are free to fetch pseudonymous user identifiers from their local provider, and use these in rooms. These pseudonymns need only identify the client's provider to other providers and clients. The actual user identity could be shared among the active participants of the room, by using a credential with selective disclosures, or by signing a binding with both the pseudonymous signature key and the "real" identity signature key and presenting the binding to other members.<a href="#section-13-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-14">
      <h2 id="name-security-considerations">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-14-1">TODO Security<a href="#section-14-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-15">
      <h2 id="name-iana-considerations">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-15-1">This document has no IANA actions.<a href="#section-15-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-16">
      <h2 id="name-references">
<a href="#section-16" class="section-number selfRef">16. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-16.1">
        <h3 id="name-normative-references">
<a href="#section-16.1" class="section-number selfRef">16.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-02</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mimi-arch">[I-D.mimi-arch]</dt>
        <dd>
<span class="refTitle">"*** BROKEN REFERENCE ***"</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7231">[RFC7231]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span> and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content"</span>, <span class="seriesInfo">RFC 7231</span>, <span class="seriesInfo">DOI 10.17487/RFC7231</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7231">https://www.rfc-editor.org/rfc/rfc7231</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9420">[RFC9420]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="seriesInfo">RFC 9420</span>, <span class="seriesInfo">DOI 10.17487/RFC9420</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9420">https://www.rfc-editor.org/rfc/rfc9420</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-16.2">
        <h3 id="name-informative-references">
<a href="#section-16.2" class="section-number selfRef">16.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.mahy-mimi-identity">[I-D.mahy-mimi-identity]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) Identity Concepts"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mimi-identity-02</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02">https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8555">[RFC8555]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Hoffman-Andrews, J.</span>, <span class="refAuthor">McCarney, D.</span>, and <span class="refAuthor">J. Kasten</span>, <span class="refTitle">"Automatic Certificate Management Environment (ACME)"</span>, <span class="seriesInfo">RFC 8555</span>, <span class="seriesInfo">DOI 10.17487/RFC8555</span>, <time datetime="2019-03" class="refDate">March 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8555">https://www.rfc-editor.org/rfc/rfc8555</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">TODO acknowledge.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Richard L. Barnes</span></div>
<div dir="auto" class="left"><span class="org">Cisco</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rlb@ipv.sx" class="email">rlb@ipv.sx</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Matthew Hodgson</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:matthew@matrix.org" class="email">matthew@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Rohan Mahy</span></div>
<div dir="auto" class="left"><span class="org">Wire</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rohan.mahy@wire.com" class="email">rohan.mahy@wire.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
